<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase-client.js"></script>
  <script src="auth.js"></script>

  <style>
    /* –¢–≤–æ–π –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –¥–∏–∑–∞–π–Ω */
    button, .btn-main, .btn-secondary{
      transition: transform .08s ease, filter .12s ease, box-shadow .12s ease, opacity .12s ease;
      -webkit-tap-highlight-color: transparent;
    }
    button:active, .btn-main:active, .btn-secondary:active{
      transform: translateY(1px) scale(.99);
      filter: brightness(.98);
    }
    #tab10, #tab50, #tab100{ opacity: .95; }
    .tab-active{ opacity: 1 !important; border: 2px solid #ffd25a !important; }
    .shortcutLine{
      margin-top: 12px; padding: 12px 14px; border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.05);
      font-size: 15px; line-height: 1.5; opacity: .92;
    }
    .actions{ display:flex; flex-direction:column; gap:12px; margin-top:14px; align-items:flex-start; }
    .actionItem{ display:block; width:100%; }
    .actionHint{ font-size: 14px; line-height: 1.35; opacity: .82; margin: 6px 6px 0 10px; max-width: 520px; }
    .actions .btn-main{ width: 240px; max-width: 92%; min-height: 54px; text-align: left; padding-left: 16px; padding-right: 16px; box-sizing: border-box; }
    .soft-disabled{ opacity: .72 !important; filter: saturate(.95) brightness(.92); }
    .with-lock{ position: relative; padding-left: 44px !important; }
    .with-lock::before{ content: "üîí"; position:absolute; left: 16px; top: 50%; transform: translateY(-50%); font-size: 18px; opacity: .9; }
    @keyframes softPulse {
      0%   { box-shadow: 0 0 0 0 rgba(255,210,90,.0); filter: brightness(1); }
      50%  { box-shadow: 0 0 0 6px rgba(255,210,90,.18); filter: brightness(1.06); }
      100% { box-shadow: 0 0 0 0 rgba(255,210,90,.0); filter: brightness(1); }
    }
    .pulse-once{ animation: softPulse 1.1s ease-in-out 2; }
    .treeTitle{ font-weight: 900; font-size: clamp(18px, 5.2vw, 22px); margin: 18px 0 10px; letter-spacing: .2px; white-space: nowrap; }
    #btnGoQueue{ width: 220px; max-width: 88%; min-height: 44px; padding: 10px 14px; font-size: 14px; text-align: left; box-sizing: border-box; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h1 style="margin-top:0;">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h1>
      <div class="note" id="whoNote" style="line-height:1.6;">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è...</div>

      <div class="shortcutLine">
        üìå –Ø—Ä–ª—ã–∫ –Ω–∞ —Ä–∞–±–æ—á–∏–π —Å—Ç–æ–ª: –º–µ–Ω—é –±—Ä–∞—É–∑–µ—Ä–∞ (‚ãÆ) ‚Üí ¬´–î–æ–±–∞–≤–∏—Ç—å –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω¬ª.
      </div>

      <div style="display:flex; gap:10px; margin:16px 0;">
        <button class="btn-secondary" id="tab10">10 ‚Ç¥</button>
        <button class="btn-secondary" id="tab50">50 ‚Ç¥</button>
        <button class="btn-secondary" id="tab100">100 ‚Ç¥</button>
      </div>

      <div class="note" id="lineTitle" style="margin-top:10px; font-weight:700;">–õ–∏–Ω–∏—è: --</div>
      <div class="note" id="statusBox" style="margin-top:10px; line-height:1.6;">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç—É—Å–∞...</div>

      <div class="actions" id="actionsBox" style="display:none;">
        <div class="actionItem">
          <button class="btn-main" id="btnTake3" disabled>–ó–∞–Ω—è—Ç—å 3-–µ –º–µ—Å—Ç–æ</button>
          <div class="actionHint" id="hintTake3"></div>
        </div>
      </div>

      <div id="joinBox" style="display:none; margin-top:16px;">
        <button class="btn-main" id="btnGoQueue">–ü–µ—Ä–µ–π—Ç–∏ –≤ ¬´–û—á–µ—Ä–µ–¥—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤¬ª</button>
      </div>

      <hr style="margin:18px 0; opacity:.25;" />
      <div style="margin-top:6px;">
        <div class="treeTitle">–í–∞—à–∏ –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω—ã–µ</div>
        <div class="note" id="treeBox" style="line-height:1.6;">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...</div>
      </div>

      <hr style="margin:18px 0; opacity:.25;" />
      <div class="actions" style="margin-top:0;">
        <button class="btn-secondary" id="btnPromo">–†–µ–∫–ª–∞–º–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã</button>
        <button class="btn-secondary" onclick="location.href='queue.html'">–û—á–µ—Ä–µ–¥—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</button>
      </div>
      <div id="msg" style="margin-top:12px; color:#ffd25a; text-align:center;"></div>
    </div>
  </div>

  <script>
    const qs = (s) => document.querySelector(s);
    const LINES = [10, 50, 100];
    let currentUID = null;
    let myRefCode = "";

    document.addEventListener("DOMContentLoaded", async () => {
      currentUID = await ensureAnonAuth();
      let activeLine = Number(localStorage.getItem("active_line")) || 10;

      // 1. –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      async function loadUser() {
        const { data: user } = await window.sb.from('users').select('*').eq('id', currentUID).single();
        if (user) {
          myRefCode = user.ref_code;
          qs("#whoNote").innerHTML = `–í–∞—à ID: <b>${myRefCode}</b>`;
          loadStats(); // –ó–∞–≥—Ä—É–∂–∞–µ–º —É—Ä–æ–≤–Ω–∏ –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è ID
        }
      }

      // 2. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É—Ä–æ–≤–Ω–µ–π
      async function loadStats() {
        // –£—Ä–æ–≤–µ–Ω—å 1: –ö—Ç–æ —É–∫–∞–∑–∞–ª –º–æ–π –∫–æ–¥ –∫–∞–∫ –ø—Ä–∏–≥–ª–∞—Å–∏—Ç–µ–ª—è
        const { count: countL1 } = await window.sb.from('users')
          .select('*', { count: 'exact', head: true })
          .eq('inviter_code', myRefCode);

        // –£—Ä–æ–≤–µ–Ω—å 2: –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è MVP (—Å—á–∏—Ç–∞–µ–º –≤—Ç–æ—Ä—ã—Ö —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤)
        // –í –ø–æ–ª–Ω–æ–π –≤–µ—Ä—Å–∏–∏ –∑–¥–µ—Å—å –±—É–¥–µ—Ç —Å–ª–æ–∂–Ω—ã–π –∑–∞–ø—Ä–æ—Å, –ø–æ–∫–∞ –≤—ã–≤–µ–¥–µ–º –±–∞–∑—É
        qs("#treeBox").innerHTML = `
          <div><b>–£—Ä–æ–≤–µ–Ω—å 1:</b> ${countL1 || 0} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ ‚Äî –í—ã —É –Ω–∏—Ö –Ω–∞ 2 –º–µ—Å—Ç–µ</div>
          <div style="margin-top:8px;"><b>–£—Ä–æ–≤–µ–Ω—å 2:</b> 0 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ ‚Äî –í—ã —É –Ω–∏—Ö –Ω–∞ 1 –º–µ—Å—Ç–µ</div>
          <div style="margin-top:8px;"><b>–£—Ä–æ–≤–µ–Ω—å 3:</b> - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–º–æ—â—å –í–∞–º</div>
        `;
      }

      // 3. –°—Ç–∞—Ç—É—Å –≤ –ª–∏–Ω–∏–∏
      async function loadLineData(line) {
        localStorage.setItem("active_line", line);
        LINES.forEach(l => qs("#tab"+l).classList.toggle("tab-active", l === line));
        qs("#lineTitle").textContent = `–õ–∏–Ω–∏—è: ${line} ‚Ç¥`;

        const { data: profile } = await window.sb.from('profiles').select('*').eq('user_id', currentUID).eq('line', line).single();

        if (!profile) {
          qs("#statusBox").innerHTML = "–°—Ç–∞—Ç—É—Å: <b>–Ω–µ —É—á–∞—Å—Ç–≤—É–µ—Ç–µ</b>";
          qs("#joinBox").style.display = "block";
          qs("#actionsBox").style.display = "none";
        } else {
          qs("#joinBox").style.display = "none";
          qs("#actionsBox").style.display = "block";
          renderStatus(profile.status);
        }
      }

      function renderStatus(status) {
        const box = qs("#statusBox");
        const btn = qs("#btnTake3");
        const hint = qs("#hintTake3");

        if (status === 'candidate_waiting') {
          box.innerHTML = `<div style="border:1px solid #ffd25a; padding:10px; border-radius:10px; text-align:center;">üïí –û–ñ–ò–î–ê–ï–ú –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–Ø</div>`;
          btn.disabled = true;
          btn.classList.add("with-lock", "soft-disabled");
          hint.textContent = "–°—Ç–∞–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–æ–º–æ—â–∏.";
        } 
        else if (status === 'confirmed_can_take3') {
          box.innerHTML = `<div style="border:1px solid #78dc8c; padding:10px; border-radius:10px; text-align:center;">‚úÖ –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–û</div>`;
          btn.disabled = false;
          btn.classList.remove("with-lock", "soft-disabled");
          btn.classList.add("pulse-once");
          hint.textContent = "–ü–æ–º–æ—â—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞! –ù–∞–∂–∏–º–∞–π—Ç–µ.";
        }
        else if (status === 'member') {
          box.innerHTML = "–°—Ç–∞—Ç—É—Å: <b>–£—á–∞—Å—Ç–Ω–∏–∫</b>";
          btn.disabled = true;
          hint.textContent = "–í—ã —É–∂–µ –≤ –æ—á–µ—Ä–µ–¥–∏!";
        }
      }

      // –ö–Ω–æ–ø–∫–∞ "–ó–∞–Ω—è—Ç—å –º–µ—Å—Ç–æ"
      qs("#btnTake3").onclick = async () => {
        const line = localStorage.getItem("active_line");
        const { error } = await window.sb.from('profiles').update({ status: 'member' }).eq('user_id', currentUID).eq('line', line);
        if (!error) {
          qs("#msg").textContent = "‚úÖ –£—Å–ø–µ—à–Ω–æ! –í—ã —Å—Ç–∞–ª–∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–º.";
          loadLineData(Number(line));
        }
      };

      // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
      LINES.forEach(l => {
        qs("#tab"+l).onclick = () => loadLineData(l);
      });

      qs("#btnPromo").onclick = () => location.href = `promo.html?ref=${myRefCode}`;
      qs("#btnGoQueue").onclick = () => location.href = `queue.html?line=${localStorage.getItem("active_line")}`;

      await loadUser();
      loadLineData(activeLine);
    });
  </script>
</body>
</html>
