 <!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Личный кабинет</title>
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h1 style="margin-top:0;">Личный кабинет</h1>

      <div class="note" id="whoNote" style="line-height:1.6;"></div>

      <!-- Переключатель линий -->
      <div style="display:flex; gap:10px; margin:16px 0;">
        <button class="btn-secondary" id="tab10">10 ₴</button>
        <button class="btn-secondary" id="tab50">50 ₴</button>
        <button class="btn-secondary" id="tab100">100 ₴</button>
      </div>

      <!-- Блок линии -->
      <div class="note" id="lineTitle" style="margin-top:10px; font-weight:700;"></div>

      <div class="note" id="statusBox" style="margin-top:10px; line-height:1.6;"></div>

      <!-- Кнопки действий (активность зависит от статуса) -->
      <div style="display:flex; flex-wrap:wrap; gap:10px; margin-top:14px;">
        <button class="btn-main" id="btnWait" disabled>Ожидаем подтверждения</button>
        <button class="btn-main" id="btnTake3" disabled>Занять 3-е место</button>
        <button class="btn-main" id="btnConfirm" disabled>Подтвердить помощь</button>
        <button class="btn-secondary" id="btnReject" disabled>Отклонить</button>
      </div>

      <!-- Если не участвует в линии -->
      <div id="joinBox" style="display:none; margin-top:16px;">
        <div class="note" style="line-height:1.6;">
          В этой линии вы пока не участвуете.
        </div>
        <button class="btn-main" id="btnGoQueue" style="margin-top:10px;">
          Перейти в «Очередь участников»
        </button>
      </div>

      <!-- Дерево приглашённых (2 уровня) -->
      <div style="margin-top:18px;">
        <div class="note" style="font-weight:700; margin-bottom:8px;">Дерево приглашённых (2 уровня)</div>
        <div class="note" id="treeBox" style="line-height:1.6;"></div>
      </div>

      <hr style="margin:18px 0; opacity:.25;" />

      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button class="btn-secondary" id="btnPromo">Рекламные материалы</button>
        <button class="btn-secondary" id="btnBackQueue">Очередь участников</button>
      </div>

      <div class="note" id="msg" style="margin-top:12px;"></div>
    </div>
  </div>

  <script>
    // =========================================================
    // ЛОГИКА MVP (без базы, без квитанций)
    //
    // Важно:
    // - my_id      = ваш собственный ID (показываем "Ваш ID")
    // - ref_owner  = ID того, по чьей ссылке вы пришли (пригласивший)
    //
    // Состояния линии (на одну линию):
    // none | candidate_waiting | confirmed_can_take3 | member
    // =========================================================

    // ===== helpers =====
    const qs = (s) => document.querySelector(s);
    const LINES = [10, 50, 100];

    function getParams() {
      const p = new URLSearchParams(location.search);
      return {
        ref: p.get("ref") || "",                // ref из URL: считаем владельцем реф-ссылки (пригласившим)
        line: Number(p.get("line") || 0),       // активная линия из URL
        role: p.get("role") || ""               // для теста: role=receiver1 (получатель №1)
      };
    }

    // --- localStorage keys ---
    const KEY_ACTIVE_LINE = "active_line";
    const KEY_MY_ID = "my_id";
    const KEY_REF_OWNER = "ref_owner";
    const KEY_STATE = "cabinet_state";

    // Хранилище статусов по линиям (MVP на localStorage)
    // statuses: none | candidate_waiting | confirmed_can_take3 | member
    function readState() {
      try {
        return JSON.parse(localStorage.getItem(KEY_STATE) || "{}");
      } catch {
        return {};
      }
    }
    function writeState(state) {
      localStorage.setItem(KEY_STATE, JSON.stringify(state));
    }

    // Стартовый дефолт (создаём объект для всех линий)
    function ensureDefaults() {
      const state = readState();
      if (!state.lines) state.lines = {};
      for (const line of LINES) {
        if (!state.lines[String(line)]) {
          state.lines[String(line)] = {
            status: "none",
            // дерево приглашённых — заглушки
            tree: { level1: [], level2: [] }
          };
        }
      }
      writeState(state);
    }

    function setActiveLine(line) {
      localStorage.setItem(KEY_ACTIVE_LINE, String(line));
      render(line);
    }

    function getActiveLine() {
      const saved = Number(localStorage.getItem(KEY_ACTIVE_LINE) || 0);
      if (LINES.includes(saved)) return saved;
      return 50; // дефолт
    }

    function setButtonsEnabled({ wait, take3, confirm, reject }) {
      // ВАЖНО: btnWait — индикатор. Мы всегда держим его disabled.
      // А "подсветку" можно потом сделать стилем.
      qs("#btnWait").disabled = true;

      qs("#btnTake3").disabled = !take3;
      qs("#btnConfirm").disabled = !confirm;
      qs("#btnReject").disabled = !reject;

      // не используем wait как кликабельность (индикатор)
    }

    function setTabActive(line) {
      for (const l of LINES) {
        const btn = qs("#tab" + l);
        btn.className = (l === line) ? "btn-main" : "btn-secondary";
      }
    }

    function renderTree(tree) {
      const l1 = tree?.level1 || [];
      const l2 = tree?.level2 || [];
      const fmt = (arr) => arr.length ? arr.map((x, i) => `${i + 1}) ${x}`).join("<br>") : "— пока пусто —";

      return `
        <div><b>Уровень 1</b> (приглашённые вами):<br>${fmt(l1)}</div>
        <br>
        <div><b>Уровень 2</b> (приглашённые вашими приглашёнными):<br>${fmt(l2)}</div>
      `;
    }

    function showMsg(t) {
      qs("#msg").textContent = t;
    }

    function setStatus(line, status) {
      const state = readState();
      state.lines[String(line)].status = status;
      writeState(state);
      render(line);
    }

    // ===== main render =====
    function render(line) {
      const { role } = getParams();
      const canModerate = (role === "receiver1"); // тестовая роль: получатель №1

      const state = readState();
      const data = state.lines[String(line)];
      const status = data.status;

      setTabActive(line);
      qs("#lineTitle").textContent = `Линия: ${line} ₴`;

      // joinBox показываем только если не участвует
      const isNone = status === "none";
      qs("#joinBox").style.display = isNone ? "block" : "none";

      // дефолт: все действия выключены (btnWait всегда disabled)
      setButtonsEnabled({ wait: false, take3: false, confirm: false, reject: false });

      if (isNone) {
        qs("#statusBox").innerHTML =
          `Статус: <b>не участвуете</b><br>` +
          `Чтобы участвовать в этой линии — пройдите процедуру через «Очередь участников».`;
      }

      if (status === "candidate_waiting") {
        qs("#statusBox").innerHTML =
          `Статус: <b>кандидат</b><br>` +
          `Ожидаем подтверждения от получателя №1.<br>` +
          `<span style="opacity:.85;">(таймер подключим позже)</span>`;

        // тут ничего не кликается у кандидата
        // а у получателя №1 (role=receiver1) появятся confirm/reject
        setButtonsEnabled({ take3: false, confirm: canModerate, reject: canModerate });
      }

      if (status === "confirmed_can_take3") {
        qs("#statusBox").innerHTML =
          `Статус: <b>подтверждено</b><br>` +
          `Теперь можно нажать «Занять 3-е место» и создать свою личную тройку в этой линии.`;

        setButtonsEnabled({ take3: true, confirm: false, reject: false });
      }

      if (status === "member") {
        qs("#statusBox").innerHTML =
          `Статус: <b>участник</b><br>` +
          `У вас есть личная тройка в этой линии, а ваша реф-ссылка ведёт на визитку.`;

        setButtonsEnabled({ take3: false, confirm: false, reject: false });
      }

      // дерево
      qs("#treeBox").innerHTML = renderTree(data.tree);
      qs("#msg").textContent = "";
    }

    // ===== init =====
    (function init() {
      ensureDefaults();

      const { ref, line } = getParams();

      // ref из URL = пригласивший (ref_owner)
      if (ref) localStorage.setItem(KEY_REF_OWNER, ref);

      // my_id: если ещё не задан — создаём из ref (для теста) или ставим TEST123
      const myId = localStorage.getItem(KEY_MY_ID) || ref || "TEST123";
      localStorage.setItem(KEY_MY_ID, myId);

      const refOwner = localStorage.getItem(KEY_REF_OWNER) || "";

      qs("#whoNote").innerHTML =
        `Ваш ID: <b>${myId}</b>` +
        (refOwner ? `<br>Пришли по ссылке от: <b>${refOwner}</b>` : "");

      // активная линия: из URL или сохранённая
      const active = LINES.includes(line) ? line : getActiveLine();
      setActiveLine(active);

      // табы
      qs("#tab10").addEventListener("click", () => setActiveLine(10));
      qs("#tab50").addEventListener("click", () => setActiveLine(50));
      qs("#tab100").addEventListener("click", () => setActiveLine(100));

      // переход в promo (в promo передаём МОЙ id)
      qs("#btnPromo").addEventListener("click", () => {
        const me = localStorage.getItem(KEY_MY_ID) || "";
        location.href = `promo.html${me ? `?ref=${encodeURIComponent(me)}` : ""}`;
      });

      // переход в очередь (показываем очередь владельца = me)
      qs("#btnBackQueue").addEventListener("click", () => {
        const me = localStorage.getItem(KEY_MY_ID) || "";
        location.href = `queue.html${me ? `?ref=${encodeURIComponent(me)}` : ""}`;
      });

      // если "не участвует" — идём в очередь на активную линию
      qs("#btnGoQueue").addEventListener("click", () => {
        const me = localStorage.getItem(KEY_MY_ID) || "";
        const l = getActiveLine();
        location.href = `queue.html?line=${encodeURIComponent(l)}${me ? `&ref=${encodeURIComponent(me)}` : ""}`;
      });

      // ===== кнопки действий (MVP) =====

      // Кандидат: занять 3-е место можно только в confirmed_can_take3
      qs("#btnTake3").addEventListener("click", () => {
        const l = getActiveLine();
        setStatus(l, "member");
        showMsg("✅ Вы стали участником в этой линии (MVP). Следующий шаг — реальный сдвиг/создание тройки.");
      });

      // Подтвердить / Отклонить — это роль получателя №1 (для теста: &role=receiver1)
      qs("#btnConfirm").addEventListener("click", () => {
        const l = getActiveLine();
        setStatus(l, "confirmed_can_take3");
        showMsg("✅ Подтверждение сделано (MVP). Теперь кандидату доступно «Занять 3-е место».");
      });

      qs("#btnReject").addEventListener("click", () => {
        const l = getActiveLine();
        setStatus(l, "none");
        showMsg("⛔ Отклонено (MVP). Сброс участия в линии.");
      });

    })();
  </script>
</body>
</html>
   
 
