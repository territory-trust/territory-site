<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–û–ø–ª–∞—Ç–∞ ‚Äî –¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è –¥–æ–≤–µ—Ä–∏—è</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase-client.js"></script>
  <script src="auth.js"></script>
  <style>
    .wrap.pay .card { padding-bottom: 18px; }
    .kv .v { font-weight: 800; font-size: 18px; }
    .copy-mini { border: 1px solid rgba(255,210,90,.45); background: rgba(10, 80, 150, .25); border-radius: 999px; padding: 10px 14px; cursor: pointer; color: #ffd25a; font-weight: bold; }
    .checkRow { display:flex; gap: 12px; padding: 12px; border-radius: 14px; border: 1px solid rgba(255,255,255,0.12); align-items: center; }
    .file-btn { display: inline-block; padding: 14px; background: #2a5298; color: #fff; cursor: pointer; border-radius: 10px; text-align: center; width: 100%; box-sizing: border-box; font-weight: bold; }
    #notifyChk { width: 20px; height: 20px; }
  </style>
</head>
<body>
  <div class="wrap pay">
    <div class="card">
      <h1>–û–ø–ª–∞—Ç–∞ –ø–æ–º–æ—â–∏</h1>
      <div class="sub">–õ–∏–Ω–∏—è: <span id="linePill">‚Äî</span> | –°—É–º–º–∞: <b id="sumText">‚Äî</b></div>

      <div class="box">
        <div class="kv">
          <div class="k">–ü–æ–ª—É—á–∞—Ç–µ–ª—å (‚Ññ1 –≤ –æ—á–µ—Ä–µ–¥–∏)</div>
          <div class="v" id="toNick">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
        <div class="kv" style="margin-top:15px;">
          <div class="k">–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã</div>
          <div style="display:flex; align-items:center; justify-content: space-between; gap:10px;">
            <div class="v" id="toCard">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            <button id="copyBtn" class="copy-mini">üìã COPY</button>
          </div>
        </div>
      </div>

      <div class="box" style="margin-top:20px;">
        <label class="file-btn" for="receiptFile" id="fileLabel">üìé –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å –∫–≤–∏—Ç–∞–Ω—Ü–∏—é</label>
        <input type="file" id="receiptFile" accept="image/*" style="display:none;">
        <div id="fileName" style="margin-top:10px; font-size:13px; color: #fff; text-align: center;"></div>
      </div>

      <div class="box">
        <div class="checkRow">
          <input id="notifyChk" type="checkbox">
          <span style="font-size: 14px;">üîî –í–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</span>
        </div>
      </div>

      <div style="display:flex; gap:10px; margin-top:25px;">
        <button class="btn-main" id="sentBtn" disabled style="flex:1; opacity: 0.5;">–î–∞–ª–µ–µ</button>
        <button class="btn-secondary" onclick="history.back()" style="flex:1">–ù–∞–∑–∞–¥</button>
      </div>
      <div id="resultMsg" style="margin-top:15px; color: #ffd25a; text-align: center; font-weight: bold;"></div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      // 1. –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
      let uid;
      try { uid = await ensureAnonAuth(); } catch (e) { console.error(e); }

      const p = new URLSearchParams(location.search);
      const line = p.get("line") || localStorage.getItem("active_line") || "10";
      
      document.getElementById("linePill").textContent = line;
      document.getElementById("sumText").textContent = line + " ‚Ç¥";

      // 2. –ü–æ–∏—Å–∫ –ø–æ–ª—É—á–∞—Ç–µ–ª—è
      async function fetchRecipient() {
        const { data: queue } = await window.sb.from('queues').select('participant_id').eq('line', line).eq('pos', 1).single();
        if (queue) {
          const { data: prof } = await window.sb.from('profiles').select('nick, full_card').eq('user_id', queue.participant_id).single();
          if (prof) {
            document.getElementById("toNick").textContent = prof.nick;
            document.getElementById("toCard").textContent = prof.full_card;
            return;
          }
        }
        // –ï—Å–ª–∏ –≤ –±–∞–∑–µ –ø—É—Å—Ç–æ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ê–¥–º–∏–Ω–∞
        document.getElementById("toNick").textContent = "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä";
        document.getElementById("toCard").textContent = "4441 0000 0000 0000";
      }
      fetchRecipient();

      // 3. –õ–æ–≥–∏–∫–∞ –∫–Ω–æ–ø–æ–∫
      const fileInput = document.getElementById("receiptFile");
      const notify = document.getElementById("notifyChk");
      const sentBtn = document.getElementById("sentBtn");

      fileInput.onchange = () => {
        const name = fileInput.files[0] ? fileInput.files[0].name : "";
        document.getElementById("fileName").textContent = name;
        document.getElementById("fileLabel").textContent = "‚úÖ –§–∞–π–ª –≤—ã–±—Ä–∞–Ω";
        checkForm();
      };

      notify.onchange = checkForm;

      function checkForm() {
        if (fileInput.files.length > 0 && notify.checked) {
          sentBtn.disabled = false;
          sentBtn.style.opacity = "1";
        } else {
          sentBtn.disabled = true;
          sentBtn.style.opacity = "0.5";
        }
      }

      sentBtn.onclick = async () => {
        sentBtn.disabled = true;
        document.getElementById("resultMsg").textContent = "–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö...";

        const { error } = await window.sb.from('profiles').update({ status: 'candidate_waiting' }).eq('user_id', uid).eq('line', line);
        if (!error) {
          location.href = "warning.html?line=" + line;
        } else {
          alert("–û—à–∏–±–∫–∞ –ë–î. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.");
          sentBtn.disabled = false;
        }
      };

      document.getElementById("copyBtn").onclick = () => {
        const cardText = document.getElementById("toCard").textContent;
        navigator.clipboard.writeText(cardText);
        alert("–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!");
      };
    });
  </script>
</body>
</html>
