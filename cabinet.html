<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</title>
  <link rel="stylesheet" href="styles.css" />

  <style>
    button, .btn-main, .btn-secondary{
      transition: transform .08s ease, filter .12s ease, box-shadow .12s ease, opacity .12s ease;
      -webkit-tap-highlight-color: transparent;
    }
    button:active, .btn-main:active, .btn-secondary:active{
      transform: translateY(1px) scale(.99);
      filter: brightness(.98);
    }

    #tab10, #tab50, #tab100{ opacity: .95; }
    .tab-active{ opacity: 1 !important; }

    .actions{
      display:flex;
      flex-direction:column;
      gap:12px;
      margin-top:14px;
      align-items:stretch;
    }
    .actionItem{ display:block; }
    .actionHint{
      font-size: 14px;
      line-height: 1.35;
      opacity: .82;
      margin: 6px 6px 0 10px;
    }

    .soft-disabled{
      opacity: .72 !important;
      filter: saturate(.95) brightness(.92);
    }

    .with-lock{
      position: relative;
      padding-left: 44px !important;
    }
    .with-lock::before{
      content: "üîí";
      position:absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 18px;
      opacity: .9;
    }

    @keyframes softPulse {
      0%   { box-shadow: 0 0 0 0 rgba(255,210,90,.0); filter: brightness(1); }
      50%  { box-shadow: 0 0 0 6px rgba(255,210,90,.18); filter: brightness(1.06); }
      100% { box-shadow: 0 0 0 0 rgba(255,210,90,.0); filter: brightness(1); }
    }
    .pulse-once{
      animation: softPulse 1.1s ease-in-out 2;
    }

    .treeTitle{
      font-weight: 900;
      font-size: 28px;
      margin: 18px 0 10px;
      letter-spacing: .2px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h1 style="margin-top:0;">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h1>

      <div class="note" id="whoNote" style="line-height:1.6;"></div>

      <div style="display:flex; gap:10px; margin:16px 0;">
        <button class="btn-secondary" id="tab10" type="button">10 ‚Ç¥</button>
        <button class="btn-secondary" id="tab50" type="button">50 ‚Ç¥</button>
        <button class="btn-secondary" id="tab100" type="button">100 ‚Ç¥</button>
      </div>

      <div class="note" id="lineTitle" style="margin-top:10px; font-weight:700;"></div>
      <div class="note" id="statusBox" style="margin-top:10px; line-height:1.6;"></div>

      <div class="actions" id="actionsBox">
        <div class="actionItem">
          <button class="btn-main" id="btnTake3" type="button" disabled>–ó–∞–Ω—è—Ç—å 3-–µ –º–µ—Å—Ç–æ</button>
          <div class="actionHint" id="hintTake3"></div>
        </div>

        <div class="actionItem">
          <button class="btn-main" id="btnConfirm" type="button" disabled>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–æ–º–æ—â—å</button>
          <div class="actionHint" id="hintConfirm"></div>
        </div>

        <div class="actionItem">
          <button class="btn-main" id="btnReject" type="button" disabled>–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
          <div class="actionHint" id="hintReject"></div>
        </div>
      </div>

      <div id="joinBox" style="display:none; margin-top:16px;">
        <button class="btn-main" id="btnGoQueue" type="button" style="margin-top:10px;">
          –ü–µ—Ä–µ–π—Ç–∏ –≤ ¬´–û—á–µ—Ä–µ–¥—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤¬ª
        </button>
      </div>

      <hr style="margin:18px 0; opacity:.25;" />

      <div style="margin-top:6px;">
        <div class="treeTitle">–î–µ—Ä–µ–≤–æ –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω—ã—Ö</div>
        <div class="note" id="treeBox" style="line-height:1.6;"></div>
      </div>

      <hr style="margin:18px 0; opacity:.25;" />

      <div class="actions" style="margin-top:0;">
        <!-- Fallback onclick: –¥–∞–∂–µ –µ—Å–ª–∏ JS —É–ø–∞–¥—ë—Ç, –Ω–∞–≤–∏–≥–∞—Ü–∏—è –±—É–¥–µ—Ç -->
        <button class="btn-secondary" id="btnPromo" type="button"
          onclick="(function(){var me=localStorage.getItem('my_id')||''; location.href='promo.html'+(me?('?ref='+encodeURIComponent(me)):'');})()">
          –†–µ–∫–ª–∞–º–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã
        </button>

        <button class="btn-secondary" id="btnBackQueue" type="button"
          onclick="(function(){var me=localStorage.getItem('my_id')||''; location.href='queue.html'+(me?('?ref='+encodeURIComponent(me)):'');})()">
          –û—á–µ—Ä–µ–¥—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
        </button>
      </div>

      <div class="note" id="msg" style="margin-top:12px;"></div>
    </div>
  </div>

  <script>
    // 1) –ü–æ–π–º–∞—Ç—å –æ—à–∏–±–∫–∏ JS –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ (–∏–Ω–∞—á–µ —Ç—ã –ø—Ä–æ—Å—Ç–æ –≤–∏–¥–∏—à—å ‚Äú–∫–Ω–æ–ø–∫–∏ –º—ë—Ä—Ç–≤—ã–µ‚Äù)
    window.addEventListener("error", function(e){
      alert("JS –æ—à–∏–±–∫–∞: " + (e.message || "unknown") + "\n–§–∞–π–ª: " + (e.filename || "") + "\n–°—Ç—Ä–æ–∫–∞: " + (e.lineno || ""));
    });

    const qs = (s) => document.querySelector(s);
    const LINES = [10, 50, 100];

    function getParams() {
      const p = new URLSearchParams(location.search);
      return {
        ref: p.get("ref") || "",
        line: Number(p.get("line") || 0),
        role: p.get("role") || "",
        debug: p.get("debug") || ""
      };
    }

    const KEY_ACTIVE_LINE = "active_line";
    const KEY_MY_ID = "my_id";
    const KEY_REF_OWNER = "ref_owner";
    const KEY_STATE = "cabinet_state";

    function readState() {
      try { return JSON.parse(localStorage.getItem(KEY_STATE) || "{}"); }
      catch { return {}; }
    }
    function writeState(state) {
      localStorage.setItem(KEY_STATE, JSON.stringify(state));
    }

    function ensureDefaults() {
      const state = readState();
      if (!state.lines) state.lines = {};
      for (const line of LINES) {
        const k = String(line);
        if (!state.lines[k]) {
          state.lines[k] = { status: "none", tree: { level1: [], level2: [] } };
        } else {
          if (!state.lines[k].tree) state.lines[k].tree = { level1: [], level2: [] };
          if (!state.lines[k].status) state.lines[k].status = "none";
        }
      }
      writeState(state);
    }

    function getActiveLine() {
      const saved = Number(localStorage.getItem(KEY_ACTIVE_LINE) || 0);
      return LINES.includes(saved) ? saved : 50;
    }

    function safeOn(sel, event, handler){
      const el = qs(sel);
      if (!el) return;
      el.addEventListener(event, handler);
    }

    function showMsg(t) {
      const m = qs("#msg");
      if (m) m.textContent = t || "";
    }

    function setTabActive(line) {
      for (const l of LINES) {
        const btn = qs("#tab" + l);
        if (!btn) continue;
        btn.classList.toggle("tab-active", l === line);
      }
    }

    function renderTree(tree) {
      const l1 = tree?.level1 || [];
      const l2 = tree?.level2 || [];
      const fmt = (arr) => arr.length ? arr.map((x, i) => `${i + 1}) ${x}`).join("<br>") : "‚Äî –ø–æ–∫–∞ –ø—É—Å—Ç–æ ‚Äî";
      return `
        <div><b>–£—Ä–æ–≤–µ–Ω—å 1:</b><br>${fmt(l1)}</div>
        <br>
        <div><b>–£—Ä–æ–≤–µ–Ω—å 2:</b><br>${fmt(l2)}</div>
      `;
    }

    function setStatus(line, status, opts = {}) {
      const state = readState();
      state.lines[String(line)].status = status;
      writeState(state);
      render(line, opts);
    }

    function setAction(btnId, hintId, cfg){
      const btn = qs(btnId);
      const hint = qs(hintId);
      if (!btn || !hint) return;

      hint.textContent = cfg.hint || "";
      btn.disabled = !cfg.enabled;

      btn.classList.toggle("soft-disabled", !cfg.enabled);
      btn.classList.toggle("with-lock", !!cfg.lock && !cfg.enabled);

      if (cfg.pulse) {
        btn.classList.remove("pulse-once");
        void btn.offsetWidth;
        btn.classList.add("pulse-once");
      } else {
        btn.classList.remove("pulse-once");
      }
    }

    function render(line, { pulse } = { pulse:false }) {
      const { role } = getParams();
      const canModerate = (role === "receiver1");

      const state = readState();
      const data = state.lines[String(line)];
      const status = data.status;

      setTabActive(line);

      const lineTitle = qs("#lineTitle");
      if (lineTitle) lineTitle.textContent = `–õ–∏–Ω–∏—è: ${line} ‚Ç¥`;

      const joinBox = qs("#joinBox");
      const actionsBox = qs("#actionsBox");
      const statusBox = qs("#statusBox");

      if (actionsBox) actionsBox.style.display = "block";
      if (joinBox) joinBox.style.display = "none";

      if (status === "none") {
        if (statusBox) statusBox.innerHTML =
          `–°—Ç–∞—Ç—É—Å: <b>–Ω–µ —É—á–∞—Å—Ç–≤—É–µ—Ç–µ</b><br>` +
          `–ß—Ç–æ–±—ã —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –≤ —ç—Ç–æ–π –ª–∏–Ω–∏–∏ ‚Äî –ø—Ä–æ–π–¥–∏—Ç–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—É —á–µ—Ä–µ–∑ ¬´–û—á–µ—Ä–µ–¥—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤¬ª.`;

        if (actionsBox) actionsBox.style.display = "none";
        if (joinBox) joinBox.style.display = "block";
      }

      if (status === "candidate_waiting") {
        if (statusBox) statusBox.innerHTML =
          `<div style="
            margin-top:10px;
            padding:14px 14px;
            border-radius:14px;
            border:1px solid rgba(255,210,90,.55);
            box-shadow: 0 0 0 2px rgba(255,210,90,.20) inset;
            text-align:center;
          ">
            <div style="font-weight:900; font-size:22px; letter-spacing:.5px;">
              üïí –û–ñ–ò–î–ê–ï–ú –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–Ø
            </div>
            <div style="margin-top:8px; font-size:17px; line-height:1.35;">
              –í—ã ‚Äî <b>–∫–∞–Ω–¥–∏–¥–∞—Ç</b>. –ñ–¥—ë–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç –ø–æ–ª—É—á–∞—Ç–µ–ª—è ‚Ññ1.
            </div>
          </div>`;

        setAction("#btnTake3", "#hintTake3", {
          enabled: false, lock: true,
          hint: "–°—Ç–∞–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–æ–º–æ—â–∏.",
          pulse: false
        });

        setAction("#btnConfirm", "#hintConfirm", {
          enabled: canModerate, lock: !canModerate,
          hint: canModerate ? "" : "–î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –ø–æ–ª—É—á–∞—Ç–µ–ª—é ‚Ññ1.",
          pulse: false
        });

        setAction("#btnReject", "#hintReject", {
          enabled: canModerate, lock: !canModerate,
          hint: canModerate ? "" : "–î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –ø–æ–ª—É—á–∞—Ç–µ–ª—é ‚Ññ1.",
          pulse: false
        });
      }

      if (status === "confirmed_can_take3") {
        if (statusBox) statusBox.innerHTML =
          `<div style="
            margin-top:10px;
            padding:14px 14px;
            border-radius:14px;
            border:1px solid rgba(120, 220, 140, .55);
            box-shadow: 0 0 0 2px rgba(120, 220, 140, .18) inset;
            text-align:center;
          ">
            <div style="font-weight:900; font-size:22px; letter-spacing:.5px;">
              ‚úÖ –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–û
            </div>
            <div style="margin-top:8px; font-size:17px; line-height:1.35;">
              –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –Ω–∞–∂–∞—Ç—å <b>¬´–ó–∞–Ω—è—Ç—å 3-–µ –º–µ—Å—Ç–æ¬ª</b>.
            </div>
          </div>`;

        setAction("#btnTake3", "#hintTake3", { enabled: true, lock:false, hint:"", pulse: !!pulse });
        setAction("#btnConfirm", "#hintConfirm", { enabled:false, lock:true, hint:"–£–∂–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ.", pulse:false });
        setAction("#btnReject", "#hintReject", { enabled:false, lock:true, hint:"–£–∂–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ.", pulse:false });
      }

      if (status === "member") {
        if (statusBox) statusBox.innerHTML =
          `–°—Ç–∞—Ç—É—Å: <b>—É—á–∞—Å—Ç–Ω–∏–∫</b><br>` +
          `–£ –≤–∞—Å –µ—Å—Ç—å –ª–∏—á–Ω–∞—è —Ç—Ä–æ–π–∫–∞ –≤ —ç—Ç–æ–π –ª–∏–Ω–∏–∏, –∞ –≤–∞—à–∞ —Ä–µ—Ñ-—Å—Å—ã–ª–∫–∞ –≤–µ–¥—ë—Ç –Ω–∞ –≤–∏–∑–∏—Ç–∫—É.`;

        setAction("#btnTake3", "#hintTake3", { enabled:false, lock:true, hint:"–£–∂–µ –∑–∞–Ω—è—Ç–æ.", pulse:false });
        setAction("#btnConfirm", "#hintConfirm", { enabled:false, lock:true, hint:"–ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.", pulse:false });
        setAction("#btnReject", "#hintReject", { enabled:false, lock:true, hint:"–ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.", pulse:false });
      }

      const treeBox = qs("#treeBox");
      if (treeBox) treeBox.innerHTML = renderTree(data.tree);

      showMsg("");
    }

    (function init() {
      ensureDefaults();

      const { ref, line, debug } = getParams();

      if (debug) alert("cabinet.js –∑–∞–ø—É—â–µ–Ω (debug=1)");

      if (ref) localStorage.setItem(KEY_REF_OWNER, ref);

      const myId = localStorage.getItem(KEY_MY_ID) || ref || "TEST123";
      localStorage.setItem(KEY_MY_ID, myId);

      const refOwner = localStorage.getItem(KEY_REF_OWNER) || "";
      const whoNote = qs("#whoNote");
      if (whoNote) {
        whoNote.innerHTML =
          `–í–∞—à ID: <b>${myId}</b>` +
          (refOwner ? `<br>–ü—Ä–∏—à–ª–∏ –ø–æ —Å—Å—ã–ª–∫–µ –æ—Ç: <b>${refOwner}</b>` : "");
      }

      const state = readState();
      if (LINES.includes(line)) {
        localStorage.setItem(KEY_ACTIVE_LINE, String(line));
        render(line, { pulse:false });
      } else {
        const activeFromState = LINES.find(l => state.lines[String(l)]?.status !== "none");
        const start = activeFromState || getActiveLine();
        localStorage.setItem(KEY_ACTIVE_LINE, String(start));
        render(start, { pulse:false });
      }

      safeOn("#tab10","click", () => { localStorage.setItem(KEY_ACTIVE_LINE, "10"); render(10, {pulse:false}); });
      safeOn("#tab50","click", () => { localStorage.setItem(KEY_ACTIVE_LINE, "50"); render(50, {pulse:false}); });
      safeOn("#tab100","click", () => { localStorage.setItem(KEY_ACTIVE_LINE, "100"); render(100, {pulse:false}); });

      safeOn("#btnPromo","click", () => {
        const me = localStorage.getItem(KEY_MY_ID) || "";
        location.href = `promo.html${me ? `?ref=${encodeURIComponent(me)}` : ""}`;
      });

      safeOn("#btnBackQueue","click", () => {
        const me = localStorage.getItem(KEY_MY_ID) || "";
        location.href = `queue.html${me ? `?ref=${encodeURIComponent(me)}` : ""}`;
      });

      safeOn("#btnGoQueue","click", () => {
        const me = localStorage.getItem(KEY_MY_ID) || "";
        const l = Number(localStorage.getItem(KEY_ACTIVE_LINE) || "50");
        location.href = `queue.html?line=${encodeURIComponent(l)}${me ? `&ref=${encodeURIComponent(me)}` : ""}`;
      });

      safeOn("#btnTake3","click", () => {
        const l = Number(localStorage.getItem(KEY_ACTIVE_LINE) || "50");
        setStatus(l, "member");
        showMsg("‚úÖ –í—ã —Å—Ç–∞–ª–∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–º –≤ —ç—Ç–æ–π –ª–∏–Ω–∏–∏ (MVP).");
      });

      safeOn("#btnConfirm","click", () => {
        const l = Number(localStorage.getItem(KEY_ACTIVE_LINE) || "50");
        setStatus(l, "confirmed_can_take3", { pulse:true });
        showMsg("‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å–¥–µ–ª–∞–Ω–æ (MVP). –¢–µ–ø–µ—Ä—å –¥–æ—Å—Ç—É–ø–Ω–æ ¬´–ó–∞–Ω—è—Ç—å 3-–µ –º–µ—Å—Ç–æ¬ª.");
      });

      safeOn("#btnReject","click", () => {
        const l = Number(localStorage.getItem(KEY_ACTIVE_LINE) || "50");
        setStatus(l, "none");
        showMsg("‚õî –û—Ç–∫–ª–æ–Ω–µ–Ω–æ (MVP). –°–±—Ä–æ—Å —É—á–∞—Å—Ç–∏—è –≤ –ª–∏–Ω–∏–∏.");
      });
    })();
  </script>
</body>
</html>

