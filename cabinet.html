<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase-client.js"></script>
  <script src="auth.js"></script>

  <style>
    /* –¢–í–û–ô –û–†–ò–ì–ò–ù–ê–õ–¨–ù–´–ô –î–ò–ó–ê–ô–ù */
    button, .btn-main, .btn-secondary{
      transition: transform .08s ease, filter .12s ease, box-shadow .12s ease, opacity .12s ease;
      -webkit-tap-highlight-color: transparent;
    }
    button:active, .btn-main:active, .btn-secondary:active{
      transform: translateY(1px) scale(.99);
      filter: brightness(.98);
    }
    #tab10, #tab50, #tab100{ opacity: .95; }
    .tab-active{ opacity: 1 !important; border: 2px solid #ffd25a !important; }
    .shortcutLine{
      margin-top: 12px; padding: 12px 14px; border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.05);
      font-size: 15px; line-height: 1.5; opacity: .92;
    }
    .actions{ display:flex; flex-direction:column; gap:12px; margin-top:14px; align-items:flex-start; }
    .actionItem{ display:block; width:100%; }
    .actionHint{ font-size: 14px; line-height: 1.35; opacity: .82; margin: 6px 6px 0 10px; max-width: 520px; }
    .actions .btn-main{ width: 240px; max-width: 92%; min-height: 54px; text-align: left; padding-left: 16px; padding-right: 16px; box-sizing: border-box; }
    .soft-disabled{ opacity: .72 !important; filter: saturate(.95) brightness(.92); }
    .with-lock{ position: relative; padding-left: 44px !important; }
    .with-lock::before{ content: "üîí"; position:absolute; left: 16px; top: 50%; transform: translateY(-50%); font-size: 18px; opacity: .9; }
    @keyframes softPulse {
      0%   { box-shadow: 0 0 0 0 rgba(255,210,90,.0); filter: brightness(1); }
      50%  { box-shadow: 0 0 0 6px rgba(255,210,90,.18); filter: brightness(1.06); }
      100% { box-shadow: 0 0 0 0 rgba(255,210,90,.0); filter: brightness(1); }
    }
    .pulse-once{ animation: softPulse 1.1s ease-in-out 2; }
    .treeTitle{ font-weight: 900; font-size: clamp(18px, 5.2vw, 22px); margin: 18px 0 10px; letter-spacing: .2px; white-space: nowrap; }
    #btnGoQueue{ width: 220px; max-width: 88%; min-height: 44px; padding: 10px 14px; font-size: 14px; text-align: left; box-sizing: border-box; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h1 style="margin-top:0;">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h1>
      <div class="note" id="whoNote" style="line-height:1.6;">–ó–∞–≥—Ä—É–∑–∫–∞ ID...</div>

      <div class="shortcutLine">
        üìå –Ø—Ä–ª—ã–∫ –Ω–∞ —Ä–∞–±–æ—á–∏–π —Å—Ç–æ–ª: –º–µ–Ω—é –±—Ä–∞—É–∑–µ—Ä–∞ (‚ãÆ) ‚Üí ¬´–î–æ–±–∞–≤–∏—Ç—å –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω¬ª.
      </div>

      <div style="display:flex; gap:10px; margin:16px 0;">
        <button class="btn-secondary" id="tab10" type="button">10 ‚Ç¥</button>
        <button class="btn-secondary" id="tab50" type="button">50 ‚Ç¥</button>
        <button class="btn-secondary" id="tab100" type="button">100 ‚Ç¥</button>
      </div>

      <div class="note" id="lineTitle" style="margin-top:10px; font-weight:700;"></div>
      <div class="note" id="statusBox" style="margin-top:10px; line-height:1.6;">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>

      <div class="actions" id="actionsBox">
        <div class="actionItem">
          <button class="btn-main" id="btnTake3" type="button" disabled>–ó–∞–Ω—è—Ç—å 3-–µ –º–µ—Å—Ç–æ</button>
          <div class="actionHint" id="hintTake3"></div>
        </div>
      </div>

      <div id="joinBox" style="display:none; margin-top:16px;">
        <button class="btn-main" id="btnGoQueue" type="button">–ü–µ—Ä–µ–π—Ç–∏ –≤ ¬´–û—á–µ—Ä–µ–¥—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤¬ª</button>
      </div>

      <hr style="margin:18px 0; opacity:.25;" />
      <div style="margin-top:6px;">
        <div class="treeTitle">–í–∞—à–∏ –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω—ã–µ</div>
        <div class="note" id="treeBox" style="line-height:1.6;">
            <div><b>–£—Ä–æ–≤–µ–Ω—å 1:</b> 0 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ ‚Äî –í—ã —É –Ω–∏—Ö –Ω–∞ 2 –º–µ—Å—Ç–µ</div>
            <div style="margin-top:8px;"><b>–£—Ä–æ–≤–µ–Ω—å 2:</b> 0 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ ‚Äî –í—ã —É –Ω–∏—Ö –Ω–∞ 1 –º–µ—Å—Ç–µ</div>
            <div style="margin-top:8px;"><b>–£—Ä–æ–≤–µ–Ω—å 3:</b> - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–º–æ—â—å –í–∞–º</div>
        </div>
      </div>

      <hr style="margin:18px 0; opacity:.25;" />
      <div class="actions" style="margin-top:0;">
        <button class="btn-secondary" id="btnPromo" type="button">–†–µ–∫–ª–∞–º–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã</button>
        <button class="btn-secondary" id="btnBackQueue" type="button">–û—á–µ—Ä–µ–¥—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</button>
      </div>
      <div class="note" id="msg" style="margin-top:12px;"></div>
    </div>
  </div>

  <script>
    const qs = (s) => document.querySelector(s);
    const LINES = [10, 50, 100];

    async function init() {
      // –ö–Ω–æ–ø–∫–∏ –¥–æ–ª–∂–Ω—ã —Ä–∞–±–æ—Ç–∞—Ç—å –°–†–ê–ó–£, –Ω–µ –¥–æ–∂–∏–¥–∞—è—Å—å –±–∞–∑—ã
      qs("#btnPromo").onclick = () => {
        const myId = localStorage.getItem("my_id") || "ID_NOT_FOUND";
        location.href = `promo.html?ref=${myId}`;
      };
      qs("#btnBackQueue").onclick = () => { location.href = "queue.html"; };
      qs("#btnGoQueue").onclick = () => { location.href = "queue.html"; };

      // –ü–æ–ø—ã—Ç–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
      let uid;
      try {
        uid = await ensureAnonAuth();
      } catch (e) {
        qs("#whoNote").textContent = "–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.";
        return;
      }

      async function loadAll() {
        const line = Number(localStorage.getItem("active_line")) || 10;
        
        // –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å
        const { data: user } = await window.sb.from('users').select('*').eq('id', uid).single();
        if (user) {
          localStorage.setItem("my_id", user.ref_code);
          qs("#whoNote").innerHTML = `–í–∞—à ID: <b>${user.ref_code}</b>`;
          
          const { count: n1 } = await window.sb.from('users').select('*', { count: 'exact', head: true }).eq('inviter_code', user.ref_code);
          qs("#treeBox").innerHTML = `
            <div><b>–£—Ä–æ–≤–µ–Ω—å 1:</b> ${n1 || 0} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ ‚Äî –í—ã —É –Ω–∏—Ö –Ω–∞ 2 –º–µ—Å—Ç–µ</div>
            <div style="margin-top:8px;"><b>–£—Ä–æ–≤–µ–Ω—å 2:</b> 0 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ ‚Äî –í—ã —É –Ω–∏—Ö –Ω–∞ 1 –º–µ—Å—Ç–µ</div>
            <div style="margin-top:8px;"><b>–£—Ä–æ–≤–µ–Ω—å 3:</b> - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–º–æ—â—å –í–∞–º</div>
          `;
        }

        LINES.forEach(l => qs("#tab" + l).classList.toggle("tab-active", l === line));
        qs("#lineTitle").textContent = `–õ–∏–Ω–∏—è: ${line} ‚Ç¥`;

        const { data: profile } = await window.sb.from('profiles').select('*').eq('user_id', uid).eq('line', line).single();

        if (!profile) {
          qs("#statusBox").innerHTML = `–°—Ç–∞—Ç—É—Å: <b>–Ω–µ —É—á–∞—Å—Ç–≤—É–µ—Ç–µ</b>`;
          qs("#joinBox").style.display = "block";
          qs("#actionsBox").style.display = "none";
        } else {
          qs("#joinBox").style.display = "none";
          qs("#actionsBox").style.display = "flex";
          
          const btn = qs("#btnTake3");
          const hint = qs("#hintTake3");
          const sBox = qs("#statusBox");

          if (profile.status === 'candidate_waiting') {
            sBox.innerHTML = `<div style="border:1px solid rgba(255,210,90,.5); padding:10px; border-radius:10px; text-align:center;">üïí –û–ñ–ò–î–ê–ï–ú –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–Ø</div>`;
            btn.disabled = true;
            btn.classList.add("with-lock", "soft-disabled");
            hint.textContent = "–°—Ç–∞–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.";
          } else if (profile.status === 'confirmed_can_take3') {
            sBox.innerHTML = `<div style="border:1px solid rgba(120, 220, 140,.5); padding:10px; border-radius:10px; text-align:center;">‚úÖ –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–û</div>`;
            btn.disabled = false;
            btn.classList.remove("with-lock", "soft-disabled");
            btn.classList.add("pulse-once");
            hint.textContent = "–ù–∞–∂–∏–º–∞–π—Ç–µ!";
          } else {
            sBox.innerHTML = `–°—Ç–∞—Ç—É—Å: <b>–£—á–∞—Å—Ç–Ω–∏–∫</b>`;
            btn.disabled = true;
            hint.textContent = "–í—ã –≤ –æ—á–µ—Ä–µ–¥–∏.";
          }
        }
      }

      LINES.forEach(l => {
        qs("#tab" + l).onclick = () => { localStorage.setItem("active_line", l); loadAll(); };
      });

      qs("#btnTake3").onclick = async () => {
        const line = localStorage.getItem("active_line") || "10";
        await window.sb.from('profiles').update({ status: 'member' }).eq('user_id', uid).eq('line', line);
        loadAll();
      };

      loadAll();
    }

    init();
  </script>
</body>
</html>
