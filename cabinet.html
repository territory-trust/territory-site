<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Личный кабинет</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase-client.js"></script>
  <script src="auth.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Личный кабинет</h1>
      <div class="note" id="whoNote">Загрузка...</div>
      
      <div style="display:flex; gap:10px; margin:16px 0;">
        <button class="btn-secondary" id="tab10">10 ₴</button>
        <button class="btn-secondary" id="tab50">50 ₴</button>
        <button class="btn-secondary" id="tab100">100 ₴</button>
      </div>

      <div class="note" id="statusBox">Загрузка статуса...</div>

      <div class="actions" id="actionsBox" style="display:none;">
          <button class="btn-main" id="btnTake3" disabled>Занять 3-е место</button>
          <p id="hintTake3" style="font-size:12px; margin-top:5px;"></p>
      </div>

      <div id="joinBox" style="display:none;">
        <button class="btn-main" onclick="location.href='queue.html'">Перейти в очередь</button>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const uid = await ensureAnonAuth();
      const LINES = [10, 50, 100];
      
      async function loadData() {
        const line = Number(localStorage.getItem("active_line")) || 10;
        
        // Получаем профиль
        const { data: user } = await window.sb.from('users').select('*').eq('id', uid).single();
        if (user) {
          document.getElementById("whoNote").innerHTML = `ID: <b>${user.ref_code}</b>`;
          localStorage.setItem("my_id", user.ref_code);
        }

        // Получаем статус линии
        const { data: profile } = await window.sb.from('profiles').select('*').eq('user_id', uid).eq('line', line).single();
        
        const statusBox = document.getElementById("statusBox");
        const actionsBox = document.getElementById("actionsBox");
        const joinBox = document.getElementById("joinBox");

        if (!profile) {
          statusBox.innerHTML = "Вы не участвуете в этой линии";
          joinBox.style.display = "block";
          actionsBox.style.display = "none";
        } else {
          joinBox.style.display = "none";
          actionsBox.style.display = "block";
          statusBox.innerHTML = `Статус: <b>${profile.status}</b>`;
          
          if (profile.status === 'confirmed_can_take3') {
            document.getElementById("btnTake3").disabled = false;
            document.getElementById("hintTake3").textContent = "Помощь подтверждена! Нажимайте.";
          } else {
            document.getElementById("btnTake3").disabled = true;
            document.getElementById("hintTake3").textContent = "Ожидайте подтверждения от получателя.";
          }
        }
      }

      LINES.forEach(l => {
        document.getElementById("tab"+l).onclick = () => {
          localStorage.setItem("active_line", l);
          loadData();
        };
      });

      loadData();
    });
  </script>
</body>
</html>
