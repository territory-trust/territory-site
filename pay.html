<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–û–ø–ª–∞—Ç–∞ ‚Äî –¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è –¥–æ–≤–µ—Ä–∏—è</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase-client.js"></script>
  <script src="auth.js"></script>
  <style>
    /* –¢–≤–æ–∏ —Å—Ç–∏–ª–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π */
    .wrap.pay .card { padding-bottom: 18px; }
    .kv .v { font-weight: 800; font-size: 18px; }
    .copy-mini{ border: 1px solid rgba(255,210,90,.45); background: rgba(10, 80, 150, .25); border-radius: 999px; padding: 10px 14px; cursor: pointer; }
    .checkRow{ display:flex; gap: 12px; padding: 12px; border-radius: 14px; border: 1px solid rgba(255,255,255,0.12); }
    .file-btn { display: inline-block; padding: 10px; background: #333; color: #fff; cursor: pointer; border-radius: 8px; }
  </style>
</head>
<body>
  <div class="wrap pay">
    <div class="card">
      <h1>–û–ø–ª–∞—Ç–∞ –ø–æ–º–æ—â–∏</h1>
      <div class="sub">–õ–∏–Ω–∏—è: <span id="linePill">‚Äî</span> | –°—É–º–º–∞: <b id="sumText">‚Äî</b></div>

      <div class="box">
        <div class="kv">
          <div class="k">–ü–æ–ª—É—á–∞—Ç–µ–ª—å (‚Ññ1 –≤ –æ—á–µ—Ä–µ–¥–∏)</div>
          <div class="v" id="toNick">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
        <div class="kv">
          <div class="k">–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã</div>
          <div style="display:flex; align-items:center; gap:10px;">
            <div class="v" id="toCard">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            <button id="copyBtn" class="copy-mini">üìã COPY</button>
          </div>
        </div>
      </div>

      <div class="box">
        <label class="file-btn" for="receiptFile">üìé –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å –∫–≤–∏—Ç–∞–Ω—Ü–∏—é</label>
        <input type="file" id="receiptFile" accept="image/*" hidden>
        <div id="fileName" style="margin-top:10px; font-size:12px;"></div>
      </div>

      <div class="box">
        <div class="checkRow">
          <input id="notifyChk" type="checkbox" />
          <span>üîî –í–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</span>
        </div>
      </div>

      <div style="display:flex; gap:10px; margin-top:20px;">
        <button class="btn-main" id="sentBtn" disabled style="flex:1">–î–∞–ª–µ–µ</button>
        <button class="btn-secondary" onclick="history.back()" style="flex:1">–ù–∞–∑–∞–¥</button>
      </div>
      <div id="resultMsg" style="margin-top:10px; color: #ffd25a;"></div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const uid = await ensureAnonAuth();
      const p = new URLSearchParams(location.search);
      const line = p.get("line") || localStorage.getItem("active_line") || "10";
      
      document.getElementById("linePill").textContent = line;
      document.getElementById("sumText").textContent = line + " ‚Ç¥";

      // 1. –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è ‚Ññ1 –∏–∑ –±–∞–∑—ã
      // –í—Ä–µ–º–µ–Ω–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ–∏ –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ, –µ—Å–ª–∏ –±–∞–∑–∞ –ø—É—Å—Ç–∞
      const { data: queue } = await window.sb.from('queues').select('participant_id').eq('line', line).eq('pos', 1).single();
      
      if (queue) {
          const { data: profile } = await window.sb.from('profiles').select('nick, full_card').eq('user_id', queue.participant_id).single();
          if (profile) {
              document.getElementById("toNick").textContent = profile.nick;
              document.getElementById("toCard").textContent = profile.full_card;
          }
      } else {
          // –ó–∞–≥–ª—É—à–∫–∞, –µ—Å–ª–∏ –≤ –±–∞–∑–µ –µ—â–µ –Ω–∏–∫–æ–≥–æ –Ω–µ—Ç
          document.getElementById("toNick").textContent = "–°–∏—Å—Ç–µ–º–∞ (–†–µ–∑–µ—Ä–≤)";
          document.getElementById("toCard").textContent = "4441 0000 0000 0000";
      }

      const receipt = document.getElementById("receiptFile");
      const notify = document.getElementById("notifyChk");
      const sentBtn = document.getElementById("sentBtn");

      receipt.onchange = () => {
          document.getElementById("fileName").textContent = receipt.files[0]?.name || "";
          checkBtn();
      };
      notify.onchange = checkBtn;

      function checkBtn() {
          sentBtn.disabled = !(receipt.files.length > 0 && notify.checked);
      }

      sentBtn.onclick = async () => {
          sentBtn.disabled = true;
          document.getElementById("resultMsg").textContent = "–û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è...";

          // –í —Ä–µ–∞–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏ –∑–¥–µ—Å—å –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ –≤ Storage. 
          // –°–µ–π—á–∞—Å –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ –±–∞–∑–µ.
          const { error } = await window.sb.from('profiles').update({ 
              status: 'candidate_waiting' 
          }).eq('user_id', uid).eq('line', line);

          if (!error) {
              location.href = "warning.html?line=" + line;
          } else {
              alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.");
              sentBtn.disabled = false;
          }
      };

      document.getElementById("copyBtn").onclick = () => {
          navigator.clipboard.writeText(document.getElementById("toCard").textContent);
          alert("–ö–∞—Ä—Ç–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!");
      };
    });
  </script>
</body>
</html>

