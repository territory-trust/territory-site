<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Очередь — Территория доверия и поддержки</title>

  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h1>Очередь участников</h1>
      <div class="subtitle">Выберите линию, чтобы увидеть трёх ближайших участников.</div>

      <div class="tabs">
        <button class="tab active" data-line="10">10 ₴</button>
        <button class="tab" data-line="50">50 ₴</button>
        <button class="tab" data-line="100">100 ₴</button>
      </div>

      <div class="queue" id="queueBlock"></div>

      <div class="hint-strong">
        Перечислишь первому → отправишь подтверждение → дождёшься подтверждения → займёшь третье место
      </div>

      <div class="buttons">
        <button class="btn-main" id="joinBtn">Присоединиться к линии 10 ₴</button>
        <button class="btn-secondary" id="cabinetBtn">Личный кабинет</button>
        <button class="btn-main" id="rulesBtn">Правила участия</button>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // ===== helpers =====
      const qs = (s) => document.querySelector(s);

      function getParams() {
        const p = new URLSearchParams(location.search);
        return {
          ref: p.get("ref") || "",   // пригласивший (владелец реф-ссылки)
          line: p.get("line") || ""
        };
      }

      // ===== ключи localStorage =====
      const KEY_ACTIVE_LINE = "active_line";
      const KEY_MY_ID = "my_id";
      const KEY_REF_OWNER = "ref_owner";
      const KEY_STATE = "cabinet_state";

      const LINES = ["10","50","100"];

      // ===== ДАННЫЕ (тестовые витрины) =====
      const queues = {
        "10": [
          { nick: "Олена", card: "5375 **** **** 1234", goal: "Ліки для мами" },
          { nick: "Ігор",  card: "4149 **** **** 5678", goal: "Оплата гуртожитку" },
          { nick: "Наталя",card: "5168 **** **** 9012", goal: "Форма дитині в школу" }
        ],
        "50": [
          { nick: "Вадим", card: "4441 **** **** 2222", goal: "Ремонт авто після ДТП" },
          { nick: "Марія", card: "4731 **** **** 3333", goal: "Курс навчання" },
          { nick: "Сергій",card: "4149 **** **** 4444", goal: "Тренування сина" }
        ],
        "100": [
          { nick: "Анна", card: "5375 **** **** 5555", goal: "Операція для тата" },
          { nick: "Роман",card: "5168 **** **** 6666", goal: "Закрити кредит" },
          { nick: "Юрій", card: "4149 **** **** 7777", goal: "Почати свій бізнес" }
        ]
      };

      // ===== ЭЛЕМЕНТЫ =====
      const queueBlock = qs("#queueBlock");
      const joinBtn = qs("#joinBtn");
      const cabinetBtn = qs("#cabinetBtn");
      const rulesBtn = qs("#rulesBtn");
      const tabs = document.querySelectorAll(".tab");

      // ===== cabinet_state =====
      function readState() {
        try { return JSON.parse(localStorage.getItem(KEY_STATE) || "{}"); }
        catch { return {}; }
      }
      function writeState(state) {
        localStorage.setItem(KEY_STATE, JSON.stringify(state));
      }

      function ensureDefaults() {
        const state = readState();
        if (!state.lines) state.lines = {};
        LINES.forEach((l) => {
          if (!state.lines[l]) {
            state.lines[l] = {
              status: "none",
              profile: null,                 // <-- ВАЖНО: профиль по линии
              tree: { level1: [], level2: [] }
            };
          } else {
            // если старый state без profile — аккуратно добавим
            if (!("profile" in state.lines[l])) state.lines[l].profile = null;
            if (!state.lines[l].tree) state.lines[l].tree = { level1: [], level2: [] };
            if (!state.lines[l].status) state.lines[l].status = "none";
          }
        });
        writeState(state);
      }

      function hasProfile(lineStr) {
        const state = readState();
        const p = state.lines?.[lineStr]?.profile;
        return !!(p && p.nick && p.goal && p.card);
      }

      // ===== текущая линия =====
      let currentLine = "10";

      function setActiveLine(lineStr) {
        currentLine = lineStr;
        localStorage.setItem(KEY_ACTIVE_LINE, String(lineStr));
        const u = new URL(location.href);
        u.searchParams.set("line", String(lineStr));
        history.replaceState({}, "", u);
      }

      function getSavedLineFromStorage() {
        const saved = localStorage.getItem(KEY_ACTIVE_LINE) || "";
        return LINES.includes(saved) ? saved : "";
      }

      // ===== рендер =====
      function renderQueue() {
        const data = queues[currentLine] || [];

        if (!data.length) {
          queueBlock.innerHTML = "<div class='hint'>Очередь пуста</div>";
          return;
        }

        let html = "";
        data.forEach((item, index) => {
          html += `
            <div class="queue-row">
              <div class="pos">${index + 1}</div>
              <div class="info">
                <div class="nick">${item.nick}</div>
                <div class="card-mask">${item.card}</div>
                <div class="goal">${item.goal}</div>
              </div>
            </div>
          `;
        });

        queueBlock.innerHTML = html;

        // Подсказка для пользователя по кнопке
        joinBtn.textContent = hasProfile(currentLine)
          ? ("Открыть кабинет линии " + currentLine + " ₴")
          : ("Присоединиться к линии " + currentLine + " ₴");
      }

      function setTabUI(lineStr) {
        tabs.forEach(t => t.classList.toggle("active", t.dataset.line === lineStr));
      }

      // ===== INIT =====
      ensureDefaults();

      const { ref, line } = getParams();

      // ref из URL — это пригласивший (владелец реф-ссылки)
      if (ref) localStorage.setItem(KEY_REF_OWNER, ref);

      // my_id: если нет — создаём тестовый (позже сделаем реальный генератор)
      const myId = localStorage.getItem(KEY_MY_ID) || "TEST123";
      localStorage.setItem(KEY_MY_ID, myId);

      const fromUrlLine = LINES.includes(line) ? line : "";
      const fromStorageLine = getSavedLineFromStorage();
      const startLine = fromUrlLine || fromStorageLine || "10";

      setActiveLine(startLine);
      setTabUI(startLine);
      renderQueue();

      // ===== вкладки =====
      tabs.forEach(tab => {
        tab.addEventListener("click", () => {
          const newLine = tab.dataset.line;
          setActiveLine(newLine);
          setTabUI(newLine);
          renderQueue();
        });
      });

      // ===== кнопки =====

      // Присоединиться:
      // - если профиля нет → в register.html
      // - если профиль уже есть → в cabinet.html на эту линию
      joinBtn.addEventListener("click", () => {
        const refOwner = localStorage.getItem(KEY_REF_OWNER) || "";
        const common = `line=${encodeURIComponent(currentLine)}${refOwner ? `&ref=${encodeURIComponent(refOwner)}` : ""}`;

        if (!hasProfile(currentLine)) {
          location.href = `register.html?${common}`;
          return;
        }

        // профиль есть → сразу кабинет
        const me = localStorage.getItem(KEY_MY_ID) || "TEST123";
        location.href = `cabinet.html?ref=${encodeURIComponent(me)}&line=${encodeURIComponent(currentLine)}`;
      });

      // Кабинет: открыть на текущей линии
      cabinetBtn.addEventListener("click", () => {
        const me = localStorage.getItem(KEY_MY_ID) || "TEST123";
        location.href = `cabinet.html?ref=${encodeURIComponent(me)}&line=${encodeURIComponent(currentLine)}`;
      });

      rulesBtn.addEventListener("click", () => {
        alert(
          "Правила (MVP):\n" +
          "1) Для каждой линии (10/50/100) регистрация отдельная.\n" +
          "2) Можно использовать разные ник и карту в разных линиях.\n" +
          "3) После регистрации в линии вы становитесь кандидатом и ждёте подтверждения.\n" +
          "4) Квитанции и база будут подключены позже."
        );
      });
    });
  </script>
</body>
</html>


