<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Регистрация — Территория доверия</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase-client.js"></script>
  <script src="auth.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Регистрация</h1>
      <div class="sub">Вы выбрали линию: <span class="line" id="lineLabel">—</span></div>

      <div class="box">
        <label>Ник (как вас показывать в очереди)</label>
        <input id="nick" placeholder="Например: олег_киев" maxlength="24" />
      </div>

      <div class="box">
        <label>Цель (коротко)</label>
        <input id="goal" placeholder="Например: лекарства, ремонт" maxlength="80" />
      </div>

      <div class="box">
        <label>Номер карты</label>
        <input id="card" type="text" inputmode="numeric" placeholder="0000 0000 0000 0000" maxlength="19" />
      </div>

      <button class="btn-main" id="nextBtn" disabled>Далее → к оплате</button>
      <button class="btn-secondary" id="backBtn" type="button">Назад</button>
      <div class="msg" id="msg"></div>
    </div>
  </div>

  <script>
  document.addEventListener("DOMContentLoaded", async () => {
    // Ждем анонимную авторизацию
    let uid;
    try { uid = await ensureAnonAuth(); } catch(e) { console.error(e); }

    const KEY_STATE = "cabinet_state";
    const KEY_ACTIVE_LINE = "active_line";
    const KEY_MY_ID = "my_id";
    const KEY_REF_OWNER = "ref_owner";

    const nick = document.getElementById("nick");
    const goal = document.getElementById("goal");
    const card = document.getElementById("card");
    const nextBtn = document.getElementById("nextBtn");
    const lineLabel = document.getElementById("lineLabel");
    const msg = document.getElementById("msg");

    function formatCard(v) {
      const d = v.replace(/\D/g, "").slice(0, 16);
      return d.replace(/(\d{4})(?=\d)/g, "$1 ").trim();
    }

    function checkForm() {
      const ok = nick.value.trim() && goal.value.trim() && card.value.replace(/\D/g, "").length === 16;
      nextBtn.disabled = !ok;
    }

    // Инициализация линии
    const p = new URLSearchParams(location.search);
    const line = Number(p.get("line")) || Number(localStorage.getItem(KEY_ACTIVE_LINE)) || 10;
    lineLabel.textContent = `${line} ₴`;
    
    const ref = p.get("ref");
    if (ref) localStorage.setItem(KEY_REF_OWNER, ref);

    card.addEventListener("input", () => { card.value = formatCard(card.value); checkForm(); });
    nick.addEventListener("input", checkForm);
    goal.addEventListener("input", checkForm);

    nextBtn.addEventListener("click", async () => {
      msg.textContent = "Сохранение...";
      const myRefCode = localStorage.getItem(KEY_MY_ID) || Math.random().toString(36).substring(2, 9).toUpperCase();
      localStorage.setItem(KEY_MY_ID, myRefCode);

      try {
        // Запись в базу
        await window.sb.from('users').upsert({ id: uid, ref_code: myRefCode, inviter_code: localStorage.getItem(KEY_REF_OWNER) });
        await window.sb.from('profiles').upsert({ 
            user_id: uid, line: line, nick: nick.value, goal: goal.value, 
            full_card: card.value.replace(/\D/g, ""), status: 'candidate_waiting' 
        });

        location.href = `pay.html?line=${line}&ref=${localStorage.getItem(KEY_REF_OWNER) || ""}`;
      } catch (err) {
        msg.textContent = "Ошибка связи с базой.";
      }
    });
  });
  </script>
</body>
</html>

