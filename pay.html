<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–û–ø–ª–∞—Ç–∞ ‚Äî –¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è –¥–æ–≤–µ—Ä–∏—è –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∏</title>
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <div class="wrap pay">
    <div class="card">
      <h1>–û–ø–ª–∞—Ç–∞ –ø–æ–º–æ—â–∏</h1>

      <div class="sub">
        –õ–∏–Ω–∏—è: <span class="pill" id="linePill">‚Äî</span>
        &nbsp;|&nbsp; –°—É–º–º–∞ –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ: <b id="sumText">‚Äî</b>
      </div>

      <!-- –ü–æ–ª—É—á–∞—Ç–µ–ª—å ‚Ññ1 -->
      <div class="box">
        <div class="row topRow">
          <div class="kv">
            <div class="k">–ü–æ–ª—É—á–∞—Ç–µ–ª—å (‚Ññ1 –≤ –æ—á–µ—Ä–µ–¥–∏)</div>
            <div class="v" id="toNick">‚Äî</div>
          </div>

          <div class="kv cardTop">
            <div class="k">–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã</div>

            <div class="card-row">
              <div class="v" id="toCard">‚Äî</div>
              <button id="copyCardBtn" type="button" class="copy-mini" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã">COPY</button>
            </div>

            <div class="copy-msg" id="copyMsg"></div>
          </div>
        </div>
      </div>

      <!-- –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è -->
      <div class="box">
        <div class="note">
          <div class="noteTitle">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –æ–ø–ª–∞—Ç–µ</div>
          <ol class="steps">
            <li>–ü–µ—Ä–µ–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –Ω–∞ –∫–∞—Ä—Ç—É —É—á–∞—Å—Ç–Ω–∏–∫–∞ ‚Ññ1 –∏—Å–ø–æ–ª—å–∑—É—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –í–∞—à–µ–≥–æ –ë–∞–Ω–∫–∞.</li>
            <li>–í –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞ —É–∫–∞–∂–∏—Ç–µ: <b>¬´–ü–æ–º–æ—â—å¬ª</b>.</li>
            <li>–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç –∫–≤–∏—Ç–∞–Ω—Ü–∏–∏ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.</li>
          </ol>
        </div>
      </div>

      <!-- –°–∫—Ä–∏–Ω -->
      <div class="box">
        <label class="file-btn" for="receiptFile">üìé –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å –∫–≤–∏—Ç–∞–Ω—Ü–∏—é</label>
        <input type="file" id="receiptFile" accept="image/*" hidden>
        <div id="fileName" class="file-name"></div>
      </div>

      <!-- –Ø—Ä–ª—ã–∫ -->
      <div class="box">
        <div class="note">
          üí° –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º –¥–æ–±–∞–≤–∏—Ç—å —è—Ä–ª—ã–∫ –Ω–∞ —Ä–∞–±–æ—á–∏–π —Å—Ç–æ–ª —á–µ—Ä–µ–∑ –º–µ–Ω—é –±—Ä–∞—É–∑–µ—Ä–∞
          <br>
          <small>–ú–µ–Ω—é ‚ãÆ ‚Üí ¬´–î–æ–±–∞–≤–∏—Ç—å –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω¬ª</small>
        </div>
      </div>

      <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
      <div class="box">
        <div class="checkRow" id="notifyRow">
          <input id="notifyChk" type="checkbox" />
          <div>
            <div>üîî –í–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ –ø–æ–º–æ—â–∏ –∏ –¥–≤–∏–∂–µ–Ω–∏–∏ –æ—á–µ—Ä–µ–¥–∏</div>
          </div>
        </div>
      </div>

      <!-- –î–µ–π—Å—Ç–≤–∏—è -->
      <button class="btn-main" id="sentBtn" disabled>–î–∞–ª–µ–µ</button>
      <button class="btn-secondary" id="backBtn" type="button">–ù–∞–∑–∞–¥</button>

      <div class="note" id="resultMsg" style="margin-top:10px;"></div>
    </div>
  </div>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    // =========================
    // KEYS (–∫–∞–∫ –≤ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–∞—Ö)
    // =========================
    const KEY_STATE = "cabinet_state";
    const KEY_ACTIVE_LINE = "active_line";
    const KEY_REF_OWNER = "ref_owner";

    const LINES = ["10","50","100"];

    // =========================
    // DOM
    // =========================
    const linePill  = document.getElementById("linePill");
    const sumText   = document.getElementById("sumText");
    const toNick    = document.getElementById("toNick");
    const toCard    = document.getElementById("toCard");
    const copyBtn   = document.getElementById("copyCardBtn");
    const copyMsg   = document.getElementById("copyMsg");

    const receipt   = document.getElementById("receiptFile");
    const fileName  = document.getElementById("fileName");
    const notify    = document.getElementById("notifyChk");
    const notifyRow = document.getElementById("notifyRow");

    const sentBtn   = document.getElementById("sentBtn");
    const backBtn   = document.getElementById("backBtn");
    const resultMsg = document.getElementById("resultMsg");

    if (!linePill || !sumText || !toNick || !toCard || !receipt || !notify || !sentBtn || !backBtn) return;

    function getParams() {
      const p = new URLSearchParams(location.search);
      return {
        line: p.get("line") || "",
        ref:  p.get("ref")  || "" // –ø—Ä–∏–≥–ª–∞—Å–∏–≤—à–∏–π (–µ—Å–ª–∏ –ø—Ä–æ—Ç–∞—â–∏–ª–∏)
      };
    }

    function resolveLine() {
      const { line } = getParams();
      if (LINES.includes(line)) return line;

      const saved = localStorage.getItem(KEY_ACTIVE_LINE) || "";
      if (LINES.includes(saved)) return saved;

      return "50";
    }

    // =========================
    // TEST DATA: –ø–æ–ª—É—á–∞—Ç–µ–ª—å ‚Ññ1
    // =========================
    const firstByLine = {
      "10":  { nick: "–û–ª–µ–Ω–∞", card: "5375 1234 5678 1234" },
      "50":  { nick: "–í–∞–¥–∏–º", card: "4441 2222 3333 2222" },
      "100": { nick: "–ê–Ω–Ω–∞",  card: "5375 5555 6666 5555" }
    };

    // =========================
    // State helpers
    // =========================
    function readState() {
      try { return JSON.parse(localStorage.getItem(KEY_STATE) || "{}"); }
      catch { return {}; }
    }
    function writeState(state) {
      localStorage.setItem(KEY_STATE, JSON.stringify(state));
    }
    function ensureDefaults(state) {
      if (!state.lines) state.lines = {};
      LINES.forEach(l => {
        if (!state.lines[l]) state.lines[l] = { status: "none", profile: null, tree: { level1: [], level2: [] } };
        if (!("status" in state.lines[l])) state.lines[l].status = "none";
        if (!("profile" in state.lines[l])) state.lines[l].profile = null;
        if (!state.lines[l].tree) state.lines[l].tree = { level1: [], level2: [] };
      });
      return state;
    }

    // =========================
    // INIT
    // =========================
    const { ref } = getParams();
    if (ref) localStorage.setItem(KEY_REF_OWNER, ref);

    const line = resolveLine();
    localStorage.setItem(KEY_ACTIVE_LINE, line);

    const first = firstByLine[line] || firstByLine["50"];

    linePill.textContent = line;
    sumText.textContent = line + " –≥—Ä–Ω";
    toNick.textContent = first.nick;
    toCard.textContent = first.card;

    // =========================
    // COPY
    // =========================
    if (copyBtn) {
      copyBtn.addEventListener("click", async () => {
        const text = (toCard.textContent || "").replace(/\s+/g, " ").trim();
        try {
          await navigator.clipboard.writeText(text);
          const old = copyBtn.textContent;
          copyBtn.textContent = "OK";
          if (copyMsg) copyMsg.textContent = "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ";
          setTimeout(() => {
            copyBtn.textContent = old;
            if (copyMsg) copyMsg.textContent = "";
          }, 900);
        } catch {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å. –°–∫–æ–ø–∏—Ä—É–π –≤—Ä—É—á–Ω—É—é.");
        }
      });
    }

    // =========================
    // BUTTON STATE: —Ñ–∞–π–ª + —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    // =========================
    function hasFile() {
      return !!(receipt.files && receipt.files.length > 0);
    }

    function refreshBtn() {
      const ok = hasFile() && notify.checked;

      sentBtn.disabled = !ok;
      sentBtn.classList.toggle("active", ok);

      // —á—É—Ç—å ‚Äú–ª–æ–≥–∏–∫–∞-UX‚Äù: –µ—Å–ª–∏ —Ñ–∞–π–ª –µ—Å—Ç—å, –Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ—Ç ‚Äî –ø–æ–¥—Å–∫–∞–∑–∫–∞
      if (hasFile() && !notify.checked) {
        sentBtn.classList.add("ready");
      } else {
        sentBtn.classList.remove("ready");
      }
    }

    // —Å—Ç–∞—Ä—Ç
    sentBtn.classList.add("waiting");
    refreshBtn();

    receipt.addEventListener("change", () => {
      const f = receipt.files && receipt.files[0] ? receipt.files[0].name : "";
      if (fileName) fileName.textContent = f ? f : "";
      sentBtn.classList.remove("waiting");
      refreshBtn();
    });

    notify.addEventListener("change", () => {
      refreshBtn();
    });

    // =========================
    // NAV
    // =========================
    backBtn.addEventListener("click", () => history.back());

    sentBtn.addEventListener("click", (e) => {
      e.preventDefault();

      // –µ—Å–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ –≤–∫–ª—é—á–µ–Ω—ã ‚Äî –ø–æ–¥—Å–≤–µ—Ç–∏–º –∏ –Ω–µ –ø—É—Å–∫–∞–µ–º
      if (!notify.checked) {
        if (notifyRow) {
          notifyRow.classList.add("attention");
          notifyRow.scrollIntoView({ behavior: "smooth", block: "center" });
          setTimeout(() => notifyRow.classList.remove("attention"), 2500);
        }
        return;
      }

      // –µ—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω ‚Äî –Ω–µ –ø—É—Å–∫–∞–µ–º (–Ω–∞ –≤—Å—è–∫–∏–π)
      if (!hasFile()) return;

      // –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π —Ñ–∏–∫—Å–∏—Ä—É–µ–º —Å—Ç–∞—Ç—É—Å –ª–∏–Ω–∏–∏ (–µ—Å–ª–∏ –≤–¥—Ä—É–≥ –∫—Ç–æ-—Ç–æ –ø–µ—Ä–µ—Å–∫–æ—á–∏–ª —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é)
      let state = ensureDefaults(readState());
      state.lines[line].status = "candidate_waiting";
      writeState(state);

      // –î–∞–ª—å—à–µ ‚Äî —Ç–≤–æ—è –ø–µ—Ä–µ—Ö–æ–¥–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
      location.href = `warning.html?line=${encodeURIComponent(line)}`;
    });
  });
  </script>
</body>
</html>

