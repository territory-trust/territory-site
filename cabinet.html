<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</title>
  <link rel="stylesheet" href="styles.css" />

  <!-- Supabase JS (browser) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* –ù–∞–∂–∞—Ç–∏–µ (–≤—Å–µ –∫–Ω–æ–ø–∫–∏) */
    button, .btn-main, .btn-secondary{
      transition: transform .08s ease, filter .12s ease, box-shadow .12s ease, opacity .12s ease;
      -webkit-tap-highlight-color: transparent;
    }
    button:active, .btn-main:active, .btn-secondary:active{
      transform: translateY(1px) scale(.99);
      filter: brightness(.98);
    }

    /* –¢–∞–±—ã –ª–∏–Ω–∏–π */
    #tab10, #tab50, #tab100{ opacity: .95; }
    .tab-active{ opacity: 1 !important; }

    /* ===== –Ø–†–õ–´–ö: –¢–û–õ–¨–ö–û –û–î–ù–ê –°–¢–†–û–ö–ê ===== */
    .shortcutLine{
      margin-top: 12px;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      font-size: 15px;
      line-height: 1.5;
      opacity: .92;
    }

    /* ===== –ö–ù–û–ü–ö–ò –î–ï–ô–°–¢–í–ò–ô: –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ, —Å–ª–µ–≤–∞, –ù–ï –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É ===== */
    .actions{
      display:flex;
      flex-direction:column;
      gap:12px;
      margin-top:14px;
      align-items:flex-start;
    }
    .actionItem{ display:block; width:100%; }
    .actionHint{
      font-size: 14px;
      line-height: 1.35;
      opacity: .82;
      margin: 6px 6px 0 10px;
      max-width: 520px;
    }
    .actions .btn-main{
      width: 240px;
      max-width: 92%;
      min-height: 54px;
      text-align: left;
      padding-left: 16px;
      padding-right: 16px;
      box-sizing: border-box;
    }

    /* ‚Äú–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ, –Ω–æ –≤–∏–¥–Ω–æ‚Äù */
    .soft-disabled{
      opacity: .72 !important;
      filter: saturate(.95) brightness(.92);
    }

    /* –ó–∞–º–æ—á–µ–∫ —Å–ª–µ–≤–∞ */
    .with-lock{
      position: relative;
      padding-left: 44px !important;
    }
    .with-lock::before{
      content: "üîí";
      position:absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 18px;
      opacity: .9;
    }

    /* –ü—É–ª—å—Å–∞—Ü–∏—è ‚Äú—Å—Ç–∞–ª–æ –¥–æ—Å—Ç—É–ø–Ω–æ‚Äù */
    @keyframes softPulse {
      0%   { box-shadow: 0 0 0 0 rgba(255,210,90,.0); filter: brightness(1); }
      50%  { box-shadow: 0 0 0 6px rgba(255,210,90,.18); filter: brightness(1.06); }
      100% { box-shadow: 0 0 0 0 rgba(255,210,90,.0); filter: brightness(1); }
    }
    .pulse-once{ animation: softPulse 1.1s ease-in-out 2; }

    /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω—ã—Ö */
    .treeTitle{
      font-weight: 900;
      font-size: clamp(18px, 5.2vw, 22px);
      margin: 18px 0 10px;
      letter-spacing: .2px;
      white-space: nowrap;
    }

    /* ‚Üì –ö–ù–û–ü–ö–ê ‚Äú–ü–ï–†–ï–ô–¢–ò –í –û–ß–ï–†–ï–î–¨‚Äù ‚Äî –£–ó–ö–ê–Ø –ò –¢–û–ù–ö–ê–Ø */
    #btnGoQueue{
      width: 220px;
      max-width: 88%;
      min-height: 44px;
      padding: 10px 14px;
      font-size: 14px;
      text-align: left;
      box-sizing: border-box;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h1 style="margin-top:0;">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h1>

      <div class="note" id="whoNote" style="line-height:1.6;"></div>

      <div class="shortcutLine">
        üìå –Ø—Ä–ª—ã–∫ –Ω–∞ —Ä–∞–±–æ—á–∏–π —Å—Ç–æ–ª: –º–µ–Ω—é –±—Ä–∞—É–∑–µ—Ä–∞ (‚ãÆ) ‚Üí ¬´–î–æ–±–∞–≤–∏—Ç—å –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω¬ª.
      </div>

      <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –ª–∏–Ω–∏–π -->
      <div style="display:flex; gap:10px; margin:16px 0;">
        <button class="btn-secondary" id="tab10" type="button">10 ‚Ç¥</button>
        <button class="btn-secondary" id="tab50" type="button">50 ‚Ç¥</button>
        <button class="btn-secondary" id="tab100" type="button">100 ‚Ç¥</button>
      </div>

      <!-- –ë–ª–æ–∫ –ª–∏–Ω–∏–∏ -->
      <div class="note" id="lineTitle" style="margin-top:10px; font-weight:700;"></div>

      <!-- –°—Ç–∞—Ç—É—Å -->
      <div class="note" id="statusBox" style="margin-top:10px; line-height:1.6;"></div>

      <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π (–ø–æ–∫–∞ ‚Äú–≤–∏–∑—É–∞–ª‚Äù, –±–µ–∑ –∑–∞–ø–∏—Å–∏) -->
      <div class="actions" id="actionsBox">
        <div class="actionItem">
          <button class="btn-main" id="btnTake3" type="button" disabled>–ó–∞–Ω—è—Ç—å 3-–µ –º–µ—Å—Ç–æ</button>
          <div class="actionHint" id="hintTake3"></div>
        </div>

        <div class="actionItem">
          <button class="btn-main" id="btnConfirm" type="button" disabled>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–æ–º–æ—â—å</button>
          <div class="actionHint" id="hintConfirm"></div>
        </div>

        <div class="actionItem">
          <button class="btn-main" id="btnReject" type="button" disabled>–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
          <div class="actionHint" id="hintReject"></div>
        </div>
      </div>

      <!-- –ï—Å–ª–∏ –Ω–µ —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ –ª–∏–Ω–∏–∏ -->
      <div id="joinBox" style="display:none; margin-top:16px;">
        <button class="btn-main" id="btnGoQueue" type="button">
          –ü–µ—Ä–µ–π—Ç–∏ –≤ ¬´–û—á–µ—Ä–µ–¥—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤¬ª
        </button>
      </div>

      <hr style="margin:18px 0; opacity:.25;" />

      <!-- –í–∞—à–∏ –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω—ã–µ -->
      <div style="margin-top:6px;">
        <div class="treeTitle">–í–∞—à–∏ –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω—ã–µ</div>
        <div class="note" id="treeBox" style="line-height:1.6;"></div>
      </div>

      <hr style="margin:18px 0; opacity:.25;" />

      <div class="actions" style="margin-top:0;">
        <button class="btn-secondary" id="btnPromo" type="button">–†–µ–∫–ª–∞–º–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã</button>
        <button class="btn-secondary" id="btnBackQueue" type="button">–û—á–µ—Ä–µ–¥—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</button>
      </div>

      <div class="note" id="msg" style="margin-top:12px;"></div>
    </div>
  </div>

  <script>
    // =========================================================
    // READ-ONLY Supabase (—ç—Ç–∞–ø 1): —Ç–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ
    // =========================================================

    // 1) –í–°–¢–ê–í–¨ –°–Æ–î–ê –î–í–ê –ó–ù–ê–ß–ï–ù–ò–Ø –ò–ó SUPABASE:
    const SUPABASE_URL = "PASTE_SUPABASE_PROJECT_URL_HERE";
    const SUPABASE_ANON_KEY = "PASTE_SUPABASE_ANON_PUBLIC_KEY_HERE";

    const supabaseClient = (window.supabase && SUPABASE_URL && SUPABASE_ANON_KEY
      && !SUPABASE_URL.includes("PASTE_")
      && !SUPABASE_ANON_KEY.includes("PASTE_"))
      ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
      : null;

    const qs = (s) => document.querySelector(s);
    const LINES = [10, 50, 100];

    function getParams() {
      const p = new URLSearchParams(location.search);
      return {
        ref: p.get("ref") || "",
        owner: p.get("owner") || "",
        line: Number(p.get("line") || 0),
        role: p.get("role") || ""
      };
    }

    const KEY_ACTIVE_LINE = "active_line";
    const KEY_MY_ID = "my_id";
    const KEY_REF_OWNER = "ref_owner";

    function safeOn(id, event, handler){
      const el = qs(id);
      if (!el) return;
      el.addEventListener(event, handler);
    }

    function showMsg(t) {
      const m = qs("#msg");
      if (m) m.textContent = t || "";
    }

    function setTabActive(line) {
      for (const l of LINES) {
        const btn = qs("#tab" + l);
        if (!btn) continue;
        btn.classList.toggle("tab-active", l === line);
      }
    }

    function getActiveLine() {
      const saved = Number(localStorage.getItem(KEY_ACTIVE_LINE) || 0);
      if (LINES.includes(saved)) return saved;
      return 50;
    }

    // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (–ø–æ–∫–∞ –±–µ–∑ –ë–î –¥–µ—Ä–µ–≤–∞)
    function renderInviteStats() {
      return `
        <div><b>–£—Ä–æ–≤–µ–Ω—å 1:</b> 0 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ ‚Äî –í—ã —É –Ω–∏—Ö –Ω–∞ 2 –º–µ—Å—Ç–µ</div>
        <div style="margin-top:8px;"><b>–£—Ä–æ–≤–µ–Ω—å 2:</b> 0 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ ‚Äî –í—ã —É –Ω–∏—Ö –Ω–∞ 1 –º–µ—Å—Ç–µ</div>
        <div style="margin-top:8px;"><b>–£—Ä–æ–≤–µ–Ω—å 3:</b> ‚Äî –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–º–æ—â—å –í–∞–º</div>
      `;
    }

    function setAction(btnId, hintId, cfg){
      const btn = qs(btnId);
      const hint = qs(hintId);
      if (!btn || !hint) return;

      hint.textContent = cfg.hint || "";
      btn.disabled = !cfg.enabled;

      btn.classList.toggle("soft-disabled", !cfg.enabled);
      btn.classList.toggle("with-lock", !!cfg.lock && !cfg.enabled);
      btn.classList.remove("pulse-once");
    }

    // ---------- READ-ONLY: –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Supabase ----------
    async function dbLoadUser(myId){
      if (!supabaseClient) return { ok:false, reason:"Supabase –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω (–Ω–µ—Ç URL/key)." };

      // myId –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å UUID –∏–∑ users.id
      const { data, error } = await supabaseClient
        .from("users")
        .select("id, nickname")
        .eq("id", myId)
        .maybeSingle();

      if (error) return { ok:false, reason:error.message };
      if (!data) return { ok:false, reason:"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ users (–ø–æ id)." };

      return { ok:true, user:data };
    }

    async function dbLoadLines(){
      if (!supabaseClient) return { ok:false, reason:"Supabase –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω." };
      const { data, error } = await supabaseClient
        .from("lines")
        .select("id, amount")
        .in("amount", [10,50,100]);

      if (error) return { ok:false, reason:error.message };
      const map = {};
      (data || []).forEach(row => { map[String(row.amount)] = row.id; });
      return { ok:true, map };
    }

    async function dbHasParticipation(myId, lineId){
      if (!supabaseClient) return { ok:false, reason:"Supabase –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω." };

      const { data, error } = await supabaseClient
        .from("personal_queues")
        .select("id, position")
        .eq("participant_user_id", myId)
        .eq("line_id", lineId)
        .limit(1);

      if (error) return { ok:false, reason:error.message };
      return { ok:true, exists: (data && data.length > 0), row: (data && data[0]) || null };
    }

    function renderStatusNone(line){
      const statusBox = qs("#statusBox");
      const joinBox = qs("#joinBox");
      const actionsBox = qs("#actionsBox");

      if (statusBox) statusBox.innerHTML =
        `–õ–∏–Ω–∏—è: <b>${line} ‚Ç¥</b><br>` +
        `–°—Ç–∞—Ç—É—Å: <b>–Ω–µ —É—á–∞—Å—Ç–≤—É–µ—Ç–µ</b><br>` +
        `–ß—Ç–æ–±—ã —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å ‚Äî –ø—Ä–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ ¬´–û—á–µ—Ä–µ–¥—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤¬ª.`;

      if (actionsBox) actionsBox.style.display = "none";
      if (joinBox) joinBox.style.display = "block";
    }

    function renderStatusMember(line){
      const statusBox = qs("#statusBox");
      const joinBox = qs("#joinBox");
      const actionsBox = qs("#actionsBox");

      if (statusBox) statusBox.innerHTML =
        `–õ–∏–Ω–∏—è: <b>${line} ‚Ç¥</b><br>` +
        `–°—Ç–∞—Ç—É—Å: <b>—É—á–∞—Å—Ç–Ω–∏–∫</b><br>` +
        `–î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã –∏–∑ –±–∞–∑—ã (read-only).`;

      if (actionsBox) actionsBox.style.display = "block";
      if (joinBox) joinBox.style.display = "none";

      setAction("#btnTake3", "#hintTake3", { enabled:false, lock:true, hint:"–ü–æ–∫–∞ read-only —ç—Ç–∞–ø (–±–µ–∑ –∑–∞–ø–∏—Å–∏).", pulse:false });
      setAction("#btnConfirm", "#hintConfirm", { enabled:false, lock:true, hint:"–ü–æ–∫–∞ read-only —ç—Ç–∞–ø (–±–µ–∑ –∑–∞–ø–∏—Å–∏).", pulse:false });
      setAction("#btnReject", "#hintReject", { enabled:false, lock:true, hint:"–ü–æ–∫–∞ read-only —ç—Ç–∞–ø (–±–µ–∑ –∑–∞–ø–∏—Å–∏).", pulse:false });
    }

    async function renderFromDb(line){
      const lineTitle = qs("#lineTitle");
      if (lineTitle) lineTitle.textContent = `–õ–∏–Ω–∏—è: ${line} ‚Ç¥`;
      setTabActive(line);

      const treeBox = qs("#treeBox");
      if (treeBox) treeBox.innerHTML = renderInviteStats();

      const myId = localStorage.getItem(KEY_MY_ID) || "";

      // –ï—Å–ª–∏ my_id –µ—â—ë –Ω–µ UUID ‚Äî —á–µ—Å—Ç–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ –±–∞–∑–∞ –Ω–µ –≤–∫–ª—é—á–∏—Ç—Å—è
      if (!myId || myId.length < 20) {
        renderStatusNone(line);
        showMsg("‚ÑπÔ∏è –î–ª—è —á—Ç–µ–Ω–∏—è –∏–∑ –ë–î –Ω—É–∂–µ–Ω my_id = UUID –∏–∑ —Ç–∞–±–ª–∏—Ü—ã users.id. –°–µ–π—á–∞—Å —É –≤–∞—Å –≤ localStorage.my_id –Ω–µ UUID.");
        return;
      }

      const u = await dbLoadUser(myId);
      if (!u.ok) {
        renderStatusNone(line);
        showMsg("‚ö†Ô∏è –ë–∞–∑–∞: –Ω–µ —Å–º–æ–≥ –ø—Ä–æ—á–∏—Ç–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. " + u.reason);
        return;
      }

      const whoNote = qs("#whoNote");
      const refOwner = (localStorage.getItem(KEY_REF_OWNER) || "");
      if (whoNote) {
        whoNote.innerHTML =
          `–í–∞—à ID: <b>${u.user.id}</b>` +
          (u.user.nickname ? `<br>–ù–∏–∫: <b>${u.user.nickname}</b>` : "") +
          (refOwner ? `<br>–ü—Ä–∏—à–ª–∏ –ø–æ —Å—Å—ã–ª–∫–µ –æ—Ç: <b>${refOwner}</b>` : "");
      }

      const lm = await dbLoadLines();
      if (!lm.ok) {
        renderStatusNone(line);
        showMsg("‚ö†Ô∏è –ë–∞–∑–∞: –Ω–µ —Å–º–æ–≥ –ø—Ä–æ—á–∏—Ç–∞—Ç—å lines. " + lm.reason);
        return;
      }

      const lineId = lm.map[String(line)];
      if (!lineId) {
        renderStatusNone(line);
        showMsg("‚ö†Ô∏è –ë–∞–∑–∞: –≤ —Ç–∞–±–ª–∏—Ü–µ lines –Ω–µ—Ç –∑–∞–ø–∏—Å–∏ –¥–ª—è amount=" + line);
        return;
      }

      const p = await dbHasParticipation(myId, lineId);
      if (!p.ok) {
        renderStatusNone(line);
        showMsg("‚ö†Ô∏è –ë–∞–∑–∞: –Ω–µ —Å–º–æ–≥ –ø—Ä–æ—á–∏—Ç–∞—Ç—å personal_queues. " + p.reason);
        return;
      }

      if (p.exists) {
        renderStatusMember(line);
        showMsg("");
      } else {
        renderStatusNone(line);
        showMsg("");
      }
    }

    (function init(){
      const { ref, owner, line } = getParams();

      if (owner) localStorage.setItem(KEY_REF_OWNER, owner);

      // my_id: –±–µ—Ä—ë–º –∏–∑ localStorage, –∏–Ω–∞—á–µ –∏–∑ ref (–µ—Å–ª–∏ ref = UUID), –∏–Ω–∞—á–µ –ø—É—Å—Ç–æ
      // –í–ê–ñ–ù–û: –Ω–∞ read-only —ç—Ç–∞–ø–µ ref –ª—É—á—à–µ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å UUID –∏–∑ users.id
      const currentMy = localStorage.getItem(KEY_MY_ID) || "";
      const candidate = currentMy || ref || "";
      if (candidate) localStorage.setItem(KEY_MY_ID, candidate);

      // –ª–∏–Ω–∏—è
      const startLine = LINES.includes(line) ? line : getActiveLine();
      localStorage.setItem(KEY_ACTIVE_LINE, String(startLine));

      // –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
      safeOn("#tab10","click", () => { localStorage.setItem(KEY_ACTIVE_LINE,"10"); renderFromDb(10); });
      safeOn("#tab50","click", () => { localStorage.setItem(KEY_ACTIVE_LINE,"50"); renderFromDb(50); });
      safeOn("#tab100","click", () => { localStorage.setItem(KEY_ACTIVE_LINE,"100"); renderFromDb(100); });

      safeOn("#btnPromo","click", () => {
        const me = localStorage.getItem(KEY_MY_ID) || "";
        location.href = `promo.html${me ? `?ref=${encodeURIComponent(me)}` : ""}`;
      });

      safeOn("#btnBackQueue","click", () => {
        const me = localStorage.getItem(KEY_MY_ID) || "";
        location.href = `queue.html${me ? `?ref=${encodeURIComponent(me)}` : ""}`;
      });

      safeOn("#btnGoQueue","click", () => {
        const me = localStorage.getItem(KEY_MY_ID) || "";
        const l = Number(localStorage.getItem(KEY_ACTIVE_LINE) || "50");
        location.href = `queue.html?line=${encodeURIComponent(l)}${me ? `&ref=${encodeURIComponent(me)}` : ""}`;
      });

      // —Å—Ç–∞—Ä—Ç–æ–≤—ã–π —Ä–µ–Ω–¥–µ—Ä –∏–∑ –ë–î
      renderFromDb(startLine);
    })();
  </script>
</body>
</html>
